"use strict";function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var pusherPlatform=createCommonjsModule(function(module){module.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=11)}([function(e,t,r){function n(e){var t={};if(!e)return t;for(var r=0,n=e.split("\r\n");r<n.length;r++){var o=n[r],s=o.indexOf(": ");if(s>0){var i=o.substring(0,s),a=o.substring(s+2);t[i]=a}}return t}Object.defineProperty(t,"__esModule",{value:!0}),t.responseToHeadersObject=n;var o=function(){function e(e,t,r){this.statusCode=e,this.headers=t,this.info=r}return e.fromXHR=function(t){var r=t.responseText;try{r=JSON.parse(t.responseText)}catch(e){}return new e(t.status,n(t.getAllResponseHeaders()),r)},e}();t.ErrorResponse=o;var s=function(){return function(e){this.error=e}}();t.NetworkError=s;var i=function(){return function(e){this.error=e}}();t.ProtocolError=i,function(e){e[e.UNSENT=0]="UNSENT",e[e.OPENED=1]="OPENED",e[e.HEADERS_RECEIVED=2]="HEADERS_RECEIVED",e[e.LOADING=3]="LOADING",e[e.DONE=4]="DONE"}(t.XhrReadyState||(t.XhrReadyState={}))},function(module,exports){var g;g=function(){return this}();try{g=g||Function("return this")()||eval("this")}catch(e){"object"==typeof window&&(g=window)}module.exports=g},function(e,t,r){(function(e){var r;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.VERBOSE=1]="VERBOSE",e[e.DEBUG=2]="DEBUG",e[e.INFO=3]="INFO",e[e.WARNING=4]="WARNING",e[e.ERROR=5]="ERROR"}(r=t.LogLevel||(t.LogLevel={}));var n=function(){function t(t){void 0===t&&(t=2),this.threshold=t;var r=Array(),n="--------------------------------------------------------------------------------";e.console.group||(e.console.group=function(t){r.push(t),e.console.log("%c \nBEGIN GROUP: %c",n,t)}),e.console.groupEnd||(e.console.groupEnd=function(){e.console.log("END GROUP: %c\n%c",r.pop(),n)})}return t.prototype.verbose=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.log(e.console.log,r.VERBOSE,t)},t.prototype.debug=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.log(e.console.log,r.DEBUG,t)},t.prototype.info=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.log(e.console.info,r.INFO,t)},t.prototype.warn=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.log(e.console.warn,r.WARNING,t)},t.prototype.error=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.log(e.console.error,r.ERROR,t)},t.prototype.log=function(t,n,o){var s=this;if(n>=this.threshold){var i="Logger."+r[n];o.length>1?(e.console.group(),o.forEach(function(e){s.errorAwareLog(t,e,i)}),e.console.groupEnd()):this.errorAwareLog(t,o[0],i)}},t.prototype.errorAwareLog=function(e,t,r){if(null!=t&&t.info&&t.info.error_uri){var n=t.info.error_description;e((n||"An error has occurred")+". More information can be found at "+t.info.error_uri+". Error object: ",t)}else e(r+": ",t)},t}();t.ConsoleLogger=n;var o=function(){function e(){}return e.prototype.verbose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e}();t.EmptyLogger=o}).call(t,r(1))},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);t.createRetryStrategyOptionsOrDefault=function(e){var t=e.initialTimeoutMillis||1e3,r=e.maxTimeoutMillis||5e3,n=-1;return void 0!==e.limit&&null!=e.limit&&(n=e.limit),{increaseTimeout:void 0!==e.increaseTimeout?e.increaseTimeout:function(e){return 2*e>r?r:2*e},initialTimeoutMillis:t,limit:n,maxTimeoutMillis:r}};var o=function(){return function(e){this.waitTimeMillis=e}}();t.Retry=o;var s=function(){return function(e){this.error=e}}();t.DoNotRetry=s;var i=function(){function e(e,t,r){this.options=e,this.logger=t,this.retryUnsafeRequests=r,this.currentRetryCount=0,this.initialTimeoutMillis=e.initialTimeoutMillis,this.maxTimeoutMillis=e.maxTimeoutMillis,this.limit=e.limit,this.increaseTimeoutFunction=e.increaseTimeout,this.currentBackoffMillis=this.initialTimeoutMillis}return e.prototype.attemptRetry=function(e){if(this.logger.verbose(this.constructor.name+": Error received",e),this.currentRetryCount>=this.limit&&this.limit>=0)return this.logger.verbose(this.constructor.name+": Retry count is over the maximum limit: "+this.limit),new s(e);if(null==e)return new o(this.calculateMillisToRetry());if(e instanceof n.ErrorResponse&&e.headers["Retry-After"])return this.logger.verbose(this.constructor.name+": Retry-After header is present, retrying in "+e.headers["Retry-After"]),new o(1e3*parseInt(e.headers["Retry-After"],10));if(this.retryUnsafeRequests)return new o(this.calculateMillisToRetry());switch(e.constructor){case n.ErrorResponse:var t=e.statusCode,r=e.headers["Request-Method"];return t>=500&&t<600&&("GET"===(i=(i=r).toUpperCase())||"HEAD"===i||"OPTIONS"===i||"SUBSCRIBE"===i)?(this.logger.verbose(this.constructor.name+": Encountered an error with status code "+t+" and request method "+r+", will retry"),new o(this.calculateMillisToRetry())):(this.logger.verbose(this.constructor.name+": Encountered an error with status code "+t+" and request method "+r+", will not retry",e),new s(e));case n.NetworkError:return this.logger.verbose(this.constructor.name+": Encountered a network error, will retry",e),new o(this.calculateMillisToRetry());case n.ProtocolError:return this.logger.verbose(this.constructor.name+": Encountered a protocol error, will retry",e),new o(this.calculateMillisToRetry());default:return this.logger.verbose(this.constructor.name+": Encountered an error, will retry",e),new o(this.calculateMillisToRetry())}var i},e.prototype.calculateMillisToRetry=function(){return this.currentBackoffMillis=this.increaseTimeoutFunction(this.currentBackoffMillis),this.logger.verbose(this.constructor.name+": Retrying in "+this.currentBackoffMillis+"ms"),this.currentBackoffMillis},e}();t.RetryResolution=i},function(e,t,r){var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e};Object.defineProperty(t,"__esModule",{value:!0});var o=r(2),s=r(5),i=r(6),a=r(7),u=r(12),c=r(13),h=r(8),l=r(14),d=r(15),p=r(9),f=function(){function e(e){this.options=e,this.host=e.host.replace(/(\/)+$/,"");var t=e.logger||new o.ConsoleLogger;this.logger=t,this.websocketTransport=new d.default(this.host,t),this.httpTransport=new l.default(this.host,e.encrypted),this.sdkProduct=e.sdkProduct||"unknown",this.sdkVersion=e.sdkVersion||"unknown",this.sdkPlatform=navigator?"ReactNative"===navigator.product?"react-native":"web":"node"}return e.prototype.request=function(e,t){var r=this;return e.tokenProvider?e.tokenProvider.fetchToken(t).then(function(t){var r;return void 0!==e.headers?e.headers.Authorization="Bearer "+t:e.headers=((r={}).Authorization="Bearer "+t,r),e}).then(function(e){return r.makeRequest(e)}):this.makeRequest(e)},e.prototype.subscribeResuming=function(e,t,r,o,s,a){var l=c.replaceMissingListenersWithNoOps(r),d=u.subscribeStrategyListenersFromSubscriptionListeners(l),f=!1;return i.createResumingStrategy(o,h.createTokenProvidingStrategy(p.createTransportStrategy(e,this.websocketTransport,this.logger),this.logger,a),this.logger,s)({onEnd:d.onEnd,onError:d.onError,onEvent:d.onEvent,onOpen:function(e){f||(f=!0,d.onOpen(e)),l.onSubscribe()},onRetrying:d.onRetrying},n({},t,this.infoHeaders()))},e.prototype.subscribeNonResuming=function(e,t,r,o,s){var i=c.replaceMissingListenersWithNoOps(r),l=u.subscribeStrategyListenersFromSubscriptionListeners(i),d=!1;return a.createRetryingStrategy(o,h.createTokenProvidingStrategy(p.createTransportStrategy(e,this.websocketTransport,this.logger),this.logger,s),this.logger)({onEnd:l.onEnd,onError:l.onError,onEvent:l.onEvent,onOpen:function(e){d||(d=!0,l.onOpen(e)),i.onSubscribe()},onRetrying:l.onRetrying},n({},t,this.infoHeaders()))},e.prototype.infoHeaders=function(){return{"X-SDK-Language":"javascript","X-SDK-Platform":this.sdkPlatform,"X-SDK-Product":this.sdkProduct,"X-SDK-Version":this.sdkVersion}},e.prototype.makeRequest=function(e){var t=this;return s.executeNetworkRequest(function(){return t.httpTransport.request(n({},e,{headers:n({},e.headers,t.infoHeaders())}))},e).catch(function(e){throw t.logger.error(e),e})},e}();t.BaseClient=f},function(e,t,r){(function(e){Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);function o(e,t,r){return e.onreadystatechange=function(){4===e.readyState&&(e.status>=200&&e.status<300?t(e.response):0!==e.status?r(n.ErrorResponse.fromXHR(e)):r(new n.NetworkError("No Connection")))},e}t.executeNetworkRequest=function(e,t){return new Promise(function(r,n){!function(e,t){t.json?e.send(JSON.stringify(t.json)):e.send(t.body)}(o(e(),r,n),t)})},t.sendRawRequest=function(t){return new Promise(function(r,n){var s=o(new e.XMLHttpRequest,r,n);if(s.withCredentials=Boolean(t.withCredentials),s.open(t.method.toUpperCase(),t.url,!0),t.headers)for(var i in t.headers)t.headers.hasOwnProperty(i)&&s.setRequestHeader(i,t.headers[i]);s.send(t.body)})}}).call(t,r(1))},function(e,t,r){(function(e){Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=r(3);t.createResumingStrategy=function(e,t,r,n){var i=o.createRetryStrategyOptionsOrDefault(e),a=new o.RetryResolution(i,r);return function(e,n){return new s(r,n,t,e,a)}};var s=function(){return function(e,t,r,n,o){var s=this;this.unsubscribe=function(){s.state.unsubscribe()},this.onTransition=function(e){s.state=e},this.state=new i(this.onTransition,e,t,r,n,o)}}(),i=function(){function e(e,t,r,n,o,s,i){var c=this;this.onTransition=e,this.logger=t,this.headers=r,this.nextSubscribeStrategy=n,this.listeners=o,this.retryResolution=s,this.initialEventId=i;var l=i;t.verbose("ResumingSubscription: transitioning to OpeningSubscriptionState"),l&&(r["Last-Event-Id"]=l,t.verbose("ResumingSubscription: initialEventId is "+l)),this.underlyingSubscription=n({onEnd:function(r){e(new h(t,o,r))},onError:function(i){e(new u(i,e,t,r,o,n,s,l))},onEvent:function(e){l=e.eventId,o.onEvent(e)},onOpen:function(r){e(new a(t,r,o,c.underlyingSubscription,e))},onRetrying:o.onRetrying},r)}return e.prototype.unsubscribe=function(){this.onTransition(new c(this.logger)),null!=this.underlyingSubscription&&this.underlyingSubscription.unsubscribe()},e}(),a=function(){function e(e,t,r,n,o){this.logger=e,this.headers=t,this.listeners=r,this.underlyingSubscription=n,this.onTransition=o,e.verbose("ResumingSubscription: transitioning to OpenSubscriptionState"),r.onOpen(t)}return e.prototype.unsubscribe=function(){this.onTransition(new c(this.logger)),this.underlyingSubscription.unsubscribe()},e}(),u=function(){function t(t,r,s,i,u,c,d,p){var f=this;this.onTransition=r,this.logger=s,this.headers=i,this.listeners=u,this.nextSubscribeStrategy=c,this.retryResolution=d,this.timeout=-1,s.verbose("ResumingSubscription: transitioning to ResumingSubscriptionState");var g=function(t,i){u.onRetrying();var a,c=((a=t)instanceof n.ErrorResponse&&(a.headers["Request-Method"]="SUBSCRIBE"),d.attemptRetry(a));c instanceof o.Retry?f.timeout=e.setTimeout(function(){m(i)},c.waitTimeMillis):r(new l(s,u,t))},m=function(e){s.verbose("ResumingSubscription: trying to re-establish the subscription"),e&&(s.verbose("ResumingSubscription: lastEventId: "+e),i["Last-Event-Id"]=e),f.underlyingSubscription=c({onEnd:function(e){r(new h(s,u,e))},onError:function(e){g(e,p)},onEvent:function(e){p=e.eventId,u.onEvent(e)},onOpen:function(e){r(new a(s,e,u,f.underlyingSubscription,r))},onRetrying:u.onRetrying},i)};g(t,p)}return t.prototype.unsubscribe=function(){this.onTransition(new c(this.logger)),e.clearTimeout(this.timeout),null!=this.underlyingSubscription&&this.underlyingSubscription.unsubscribe()},t}(),c=function(){function e(e,t){this.logger=e,e.verbose("ResumingSubscription: transitioning to EndingSubscriptionState")}return e.prototype.unsubscribe=function(){throw new Error("Subscription is already ending")},e}(),h=function(){function e(e,t,r){this.logger=e,this.listeners=t,e.verbose("ResumingSubscription: transitioning to EndedSubscriptionState"),t.onEnd(r)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}(),l=function(){function e(e,t,r){this.logger=e,this.listeners=t,e.verbose("ResumingSubscription: transitioning to FailedSubscriptionState",r),t.onError(r)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}()}).call(t,r(1))},function(e,t,r){(function(e){Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=r(3);t.createRetryingStrategy=function(e,t,r){var n=o.createRetryStrategyOptionsOrDefault(e),i=new o.RetryResolution(n,r);return function(e,n){return new s(r,n,e,t,i)}};var s=function(){return function(e,t,r,n,o){var s=this;this.unsubscribe=function(){s.state.unsubscribe()},this.onTransition=function(e){s.state=e},this.state=new i(this.onTransition,e,t,r,n,o)}}(),i=function(){function e(e,t,r,n,o,s){var i=this;this.logger=t,this.headers=r,this.listeners=n,this.nextSubscribeStrategy=o,this.retryResolution=s,t.verbose("RetryingSubscription: transitioning to OpeningSubscriptionState"),this.underlyingSubscription=o({onEnd:function(r){return e(new c(t,n,r))},onError:function(i){return e(new a(i,e,t,r,n,o,s))},onEvent:n.onEvent,onOpen:function(r){return e(new u(t,n,r,i.underlyingSubscription,e))},onRetrying:n.onRetrying},r)}return e.prototype.unsubscribe=function(){throw this.underlyingSubscription.unsubscribe(),new Error("Method not implemented.")},e}(),a=function(){function t(t,r,s,i,a,l,d){var p=this;this.onTransition=r,this.logger=s,this.headers=i,this.listeners=a,this.nextSubscribeStrategy=l,this.retryResolution=d,this.timeout=-1,s.verbose("RetryingSubscription: transitioning to RetryingSubscriptionState");var f=function(t){a.onRetrying();var i,u=((i=t)instanceof n.ErrorResponse&&(i.headers["Request-Method"]="SUBSCRIBE"),d.attemptRetry(i));u instanceof o.Retry?p.timeout=e.setTimeout(function(){g()},u.waitTimeMillis):r(new h(s,a,t))},g=function(){s.verbose("RetryingSubscription: trying to re-establish the subscription");var e=l({onEnd:function(e){return r(new c(s,a,e))},onError:function(e){return f(e)},onEvent:a.onEvent,onOpen:function(t){r(new u(s,a,t,e,r))},onRetrying:a.onRetrying},i)};f(t)}return t.prototype.unsubscribe=function(){e.clearTimeout(this.timeout),this.onTransition(new c(this.logger,this.listeners))},t}(),u=function(){function e(e,t,r,n,o){this.logger=e,this.listeners=t,this.headers=r,this.underlyingSubscription=n,this.onTransition=o,e.verbose("RetryingSubscription: transitioning to OpenSubscriptionState"),t.onOpen(r)}return e.prototype.unsubscribe=function(){this.underlyingSubscription.unsubscribe(),this.onTransition(new c(this.logger,this.listeners))},e}(),c=function(){function e(e,t,r){this.logger=e,this.listeners=t,e.verbose("RetryingSubscription: transitioning to EndedSubscriptionState"),t.onEnd(r)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}(),h=function(){function e(e,t,r){this.logger=e,this.listeners=t,e.verbose("RetryingSubscription: transitioning to FailedSubscriptionState",r),t.onError(r)}return e.prototype.unsubscribe=function(){throw new Error("Subscription has already ended")},e}()}).call(t,r(1))},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);t.createTokenProvidingStrategy=function(e,t,r){return r?function(n,s){return new o(t,n,s,r,e)}:e};var o=function(){function e(e,t,r,n,o){var a=this;this.logger=e,this.listeners=t,this.headers=r,this.tokenProvider=n,this.nextSubscribeStrategy=o,this.unsubscribe=function(){a.state.unsubscribe(),a.state=new i(a.logger)},this.state=new s(e,r,o),this.subscribe()}return e.prototype.subscribe=function(){var e=this;this.tokenProvider.fetchToken().then(function(t){var r=Object.assign({},e.listeners);e.state.subscribe(t,{onEnd:function(t){e.state=new i(e.logger),r.onEnd(t)},onError:function(n){e.isTokenExpiredError(n)?(e.tokenProvider.clearToken(t),e.subscribe()):(e.state=new i(e.logger),r.onError(n))},onEvent:e.listeners.onEvent,onOpen:e.listeners.onOpen})}).catch(function(t){e.logger.debug("TokenProvidingSubscription: error when fetching token:",t),e.state=new i(e.logger),e.listeners.onError(t)})},e.prototype.isTokenExpiredError=function(e){return e instanceof n.ErrorResponse&&401===e.statusCode&&"authentication/expired"===e.info},e}(),s=function(){function e(e,t,r){this.logger=e,this.headers=t,this.nextSubscribeStrategy=r,e.verbose("TokenProvidingSubscription: transitioning to ActiveState")}return e.prototype.subscribe=function(e,t){var r=this;this.putTokenIntoHeader(e),this.underlyingSubscription=this.nextSubscribeStrategy({onEnd:function(e){r.logger.verbose("TokenProvidingSubscription: subscription ended"),t.onEnd(e)},onError:function(e){r.logger.verbose("TokenProvidingSubscription: subscription errored:",e),t.onError(e)},onEvent:t.onEvent,onOpen:function(e){r.logger.verbose("TokenProvidingSubscription: subscription opened"),t.onOpen(e)},onRetrying:t.onRetrying},this.headers)},e.prototype.unsubscribe=function(){null!=this.underlyingSubscription&&this.underlyingSubscription.unsubscribe()},e.prototype.putTokenIntoHeader=function(e){this.headers.Authorization="Bearer "+e,this.logger.verbose("TokenProvidingSubscription: token fetched: "+e)},e}(),i=function(){function e(e){this.logger=e,e.verbose("TokenProvidingSubscription: transitioning to InactiveState")}return e.prototype.subscribe=function(e,t){this.logger.verbose("TokenProvidingSubscription: subscribe called in Inactive state; doing nothing")},e.prototype.unsubscribe=function(){this.logger.verbose("TokenProvidingSubscription: unsubscribe called in Inactive state; doing nothing")},e}()},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.createTransportStrategy=function(e,t,r){return function(r,n){return t.subscribe(e,r,n)}}},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.HOST_BASE="pusherplatform.io"},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(4);t.BaseClient=n.BaseClient;var o=r(10);t.HOST_BASE=o.HOST_BASE;var s=r(16);t.Instance=s.default;var i=r(2);t.ConsoleLogger=i.ConsoleLogger,t.EmptyLogger=i.EmptyLogger;var a=r(0);t.ErrorResponse=a.ErrorResponse,t.NetworkError=a.NetworkError,t.responseToHeadersObject=a.responseToHeadersObject,t.XhrReadyState=a.XhrReadyState;var u=r(5);t.executeNetworkRequest=u.executeNetworkRequest,t.sendRawRequest=u.sendRawRequest;var c=r(6);t.createResumingStrategy=c.createResumingStrategy;var h=r(3);t.createRetryStrategyOptionsOrDefault=h.createRetryStrategyOptionsOrDefault,t.DoNotRetry=h.DoNotRetry,t.Retry=h.Retry,t.RetryResolution=h.RetryResolution;var l=r(7);t.createRetryingStrategy=l.createRetryingStrategy;var d=r(8);t.createTokenProvidingStrategy=d.createTokenProvidingStrategy;var p=r(9);t.createTransportStrategy=p.createTransportStrategy,t.default={BaseClient:n.BaseClient,ConsoleLogger:i.ConsoleLogger,EmptyLogger:i.EmptyLogger,Instance:s.default}},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.subscribeStrategyListenersFromSubscriptionListeners=function(e){return{onEnd:e.onEnd,onError:e.onError,onEvent:e.onEvent,onOpen:e.onOpen,onRetrying:e.onRetrying}}},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.replaceMissingListenersWithNoOps=function(e){return{onEnd:e.onEnd||function(e){},onError:e.onError||function(e){},onEvent:e.onEvent||function(e){},onOpen:e.onOpen||function(e){},onRetrying:e.onRetrying||function(){},onSubscribe:e.onSubscribe||function(){}}}},function(e,t,r){(function(e){Object.defineProperty(t,"__esModule",{value:!0});var n,o=r(0);!function(e){e[e.UNOPENED=0]="UNOPENED",e[e.OPENING=1]="OPENING",e[e.OPEN=2]="OPEN",e[e.ENDING=3]="ENDING",e[e.ENDED=4]="ENDED"}(n=t.HttpTransportState||(t.HttpTransportState={}));var s=function(){function t(e,t){var r=this;return this.gotEOS=!1,this.lastNewlineIndex=0,this.state=n.UNOPENED,this.xhr=e,this.listeners=t,this.xhr.onreadystatechange=function(){switch(r.xhr.readyState){case o.XhrReadyState.UNSENT:case o.XhrReadyState.OPENED:case o.XhrReadyState.HEADERS_RECEIVED:r.assertStateIsIn(n.OPENING);break;case o.XhrReadyState.LOADING:r.onLoading();break;case o.XhrReadyState.DONE:r.onDone()}},this.state=n.OPENING,this.xhr.send(),this}return t.prototype.unsubscribe=function(){this.state=n.ENDED,this.xhr.abort(),this.listeners.onEnd&&this.listeners.onEnd(null)},t.prototype.onLoading=function(){if(this.assertStateIsIn(n.OPENING,n.OPEN,n.ENDING),200===this.xhr.status){this.state===n.OPENING&&(this.state=n.OPEN,this.listeners.onOpen&&this.listeners.onOpen(o.responseToHeadersObject(this.xhr.getAllResponseHeaders()))),this.assertStateIsIn(n.OPEN);var e=this.onChunk();this.assertStateIsIn(n.OPEN,n.ENDING),e&&(this.state=n.ENDED,e instanceof o.ErrorResponse&&204!==e.statusCode&&this.listeners.onError&&this.listeners.onError(e))}},t.prototype.onDone=function(){if(200===this.xhr.status){this.state===n.OPENING&&(this.state=n.OPEN,this.listeners.onOpen&&this.listeners.onOpen(o.responseToHeadersObject(this.xhr.getAllResponseHeaders()))),this.assertStateIsIn(n.OPEN,n.ENDING);var e=this.onChunk();e?(this.state=n.ENDED,204===e.statusCode?this.listeners.onEnd&&this.listeners.onEnd(null):this.listeners.onError&&this.listeners.onError(e)):this.state<=n.ENDING?this.listeners.onError&&this.listeners.onError(new Error("HTTP response ended without receiving EOS message")):this.listeners.onEnd&&this.listeners.onEnd(null)}else{if(this.assertStateIsIn(n.OPENING,n.OPEN,n.ENDED),this.state===n.ENDED)return;0===this.xhr.status?this.listeners.onError&&this.listeners.onError(new o.NetworkError("Connection lost.")):this.listeners.onError&&this.listeners.onError(o.ErrorResponse.fromXHR(this.xhr))}},t.prototype.onChunk=function(){this.assertStateIsIn(n.OPEN);var e=this.xhr.responseText,t=e.lastIndexOf("\n");if(t>this.lastNewlineIndex){var r=e.slice(this.lastNewlineIndex,t).split("\n");this.lastNewlineIndex=t;for(var o=0,s=r;o<s.length;o++){var i=s[o];if(0!==i.length){var a=JSON.parse(i),u=this.onMessage(a);if(null!=u)return u}}}},t.prototype.assertStateIsIn=function(){for(var t=this,r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];if(!r.some(function(e){return e===t.state})){var s=r.map(function(e){return n[e]}).join(", "),i=n[this.state];e.console.warn("Expected this.state to be one of ["+s+"] but it is "+i)}},t.prototype.onMessage=function(e){switch(this.assertStateIsIn(n.OPEN),this.verifyMessage(e),e[0]){case 0:return null;case 1:return this.onEventMessage(e);case 255:return this.onEOSMessage(e);default:return new Error("Unknown Message: "+JSON.stringify(e))}},t.prototype.onEventMessage=function(e){if(this.assertStateIsIn(n.OPEN),4!==e.length)return new Error("Event message has "+e.length+" elements (expected 4)");e[0];var t=e[1],r=e[2],o=e[3];return"string"!=typeof t?new Error("Invalid event ID in message: "+JSON.stringify(e)):"object"!=typeof r||Array.isArray(r)?new Error("Invalid event headers in message: "+JSON.stringify(e)):(this.listeners.onEvent&&this.listeners.onEvent({body:o,headers:r,eventId:t}),null)},t.prototype.onEOSMessage=function(e){if(this.assertStateIsIn(n.OPEN),4!==e.length)return new Error("EOS message has "+e.length+" elements (expected 4)");e[0];var t=e[1],r=e[2],s=e[3];return"number"!=typeof t?new Error("Invalid EOS Status Code"):"object"!=typeof r||Array.isArray(r)?new Error("Invalid EOS ElementsHeaders"):(this.state=n.ENDING,new o.ErrorResponse(t,r,s))},t.prototype.verifyMessage=function(e){return this.gotEOS?new Error("Got another message after EOS message"):Array.isArray(e)?e.length<1?new Error("Message is empty array"):void 0:new Error("Message is not an array")},t}(),i=function(){function t(e,t){void 0===t&&(t=!0),this.baseURL=(t?"https":"http")+"://"+e}return t.prototype.request=function(e){return this.createXHR(this.baseURL,e)},t.prototype.subscribe=function(e,t,r){var n={headers:r,method:"SUBSCRIBE",path:e};return new s(this.createXHR(this.baseURL,n),t)},t.prototype.createXHR=function(t,r){var n=new e.XMLHttpRequest,o=t+"/"+r.path.replace(/^\/+/,"");if(n.open(r.method.toUpperCase(),o,!0),n=this.setJSONHeaderIfAppropriate(n,r),r.jwt&&n.setRequestHeader("authorization","Bearer "+r.jwt),r.headers)for(var s in r.headers)r.headers.hasOwnProperty(s)&&n.setRequestHeader(s,r.headers[s]);return n},t.prototype.setJSONHeaderIfAppropriate=function(e,t){return t.json&&e.setRequestHeader("content-type","application/json"),e},t}();t.default=i}).call(t,r(1))},function(e,t,r){(function(e){var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e};Object.defineProperty(t,"__esModule",{value:!0});var o,s=r(0);!function(e){e[e.Connecting=0]="Connecting",e[e.Open=1]="Open",e[e.Closing=2]="Closing",e[e.Closed=3]="Closed"}(o=t.WSReadyState||(t.WSReadyState={}));var i=function(){function e(){this.subscriptions={}}return e.prototype.add=function(e,t,r,n){return this.subscriptions[e]={headers:n,listeners:r,path:t},e},e.prototype.has=function(e){return void 0!==this.subscriptions[e]},e.prototype.isEmpty=function(){return 0===Object.keys(this.subscriptions).length},e.prototype.remove=function(e){return delete this.subscriptions[e]},e.prototype.get=function(e){return this.subscriptions[e]},e.prototype.getAll=function(){return this.subscriptions},e.prototype.getAllAsArray=function(){var e=this;return Object.keys(this.subscriptions).map(function(t){return n({subID:parseInt(t,10)},e.subscriptions[parseInt(t,10)])})},e.prototype.removeAll=function(){this.subscriptions={}},e}(),a=function(){function e(e,t){this.wsTransport=e,this.subID=t}return e.prototype.unsubscribe=function(){this.wsTransport.unsubscribe(this.subID)},e}(),u=function(){function t(e,t){this.webSocketPath="/ws",this.forcedClose=!1,this.closedError=null,this.lastSentPingID=null,this.baseURL="wss://"+e+this.webSocketPath,this.lastSubscriptionID=0,this.logger=t,this.subscriptions=new i,this.pendingSubscriptions=new i,this.connect()}return t.prototype.subscribe=function(e,t,r){this.tryReconnectIfNeeded();var n=this.lastSubscriptionID++;return this.socket.readyState!==o.Open?(this.pendingSubscriptions.add(n,e,t,r),new a(this,n)):(this.subscriptions.add(n,e,t,r),this.sendMessage(this.getMessage(100,n,e,r)),new a(this,n))},t.prototype.unsubscribe=function(e){this.sendMessage(this.getMessage(198,e));var t=this.subscriptions.get(e);t.listeners.onEnd&&t.listeners.onEnd(null),this.subscriptions.remove(e)},t.prototype.connect=function(){var t=this;this.forcedClose=!1,this.closedError=null,this.socket=new e.WebSocket(this.baseURL),this.socket.onopen=function(r){t.pendingSubscriptions.getAllAsArray().forEach(function(e){var r=e.subID,n=e.path,o=e.listeners,s=e.headers;t.subscribePending(n,o,s,r)}),t.pendingSubscriptions.removeAll(),t.pingInterval=e.setInterval(function(){if(!t.pongTimeout){var r=(new Date).getTime();1e4>r-t.lastMessageReceivedTimestamp||(t.sendMessage(t.getMessage(16,r)),t.lastSentPingID=r,t.pongTimeout=e.setTimeout(function(){1e4>(new Date).getTime()-t.lastMessageReceivedTimestamp?t.pongTimeout=null:t.close(new s.NetworkError("Pong response wasn't received within timeout"))},1e4))}},3e4)},this.socket.onmessage=function(e){return t.receiveMessage(e)},this.socket.onerror=function(e){t.logger.verbose("WebSocket encountered an error event",e)},this.socket.onclose=function(e){t.logger.verbose("WebSocket encountered a close event",e);var r=t.subscriptions.getAllAsArray().concat(t.pendingSubscriptions.getAllAsArray());t.subscriptions.removeAll(),t.pendingSubscriptions.removeAll(),r.forEach(function(e){e.listeners.onError&&e.listeners.onError(t.closedError)}),t.tryReconnectIfNeeded()}},t.prototype.close=function(t){if(this.socket instanceof e.WebSocket){var r=function(e){};null!=this.socket.onclose&&(r=this.socket.onclose.bind(this)),this.socket.onclose=function(){},this.socket.onerror=function(){},this.socket.onmessage=function(){},this.socket.onopen=function(){},this.forcedClose=!0,this.closedError=t,this.socket.close(),e.clearTimeout(this.pingInterval),e.clearTimeout(this.pongTimeout),this.pongTimeout=null,this.pingInterval=null,this.lastSentPingID=null,r()}},t.prototype.tryReconnectIfNeeded=function(){(this.forcedClose||this.socket.readyState===o.Closed)&&this.connect()},t.prototype.subscribePending=function(e,t,r,n){void 0!==n?(this.subscriptions.add(n,e,t,r),this.sendMessage(this.getMessage(100,n,e,r))):this.logger.debug("Subscription to path "+e+" has an undefined ID")},t.prototype.getMessage=function(e,t,r,n){return[e,t,r,n]},t.prototype.sendMessage=function(e){this.socket.readyState===o.Open?this.socket.send(JSON.stringify(e)):this.logger.warn("Can't send on socket in \""+o[this.socket.readyState]+'" state')},t.prototype.subscription=function(e){return this.subscriptions.get(e)},t.prototype.receiveMessage=function(e){var t;this.lastMessageReceivedTimestamp=(new Date).getTime();try{t=JSON.parse(e.data)}catch(t){return void this.close(new s.ProtocolError("Message is not valid JSON format. Getting "+e.data))}var r=this.validateMessage(t);if(r)this.close(r);else{var n=t.shift();switch(n){case 17:return void this.onPongMessage(t);case 16:return void this.onPingMessage(t);case 99:return void this.onCloseMessage(t)}var o=t.shift(),i=this.subscription(o);if(i){var a=i.listeners;switch(n){case 101:this.onOpenMessage(t,o,a);break;case 102:this.onEventMessage(t,a);break;case 199:this.onEOSMessage(t,o,a);break;default:this.close(new s.ProtocolError("Received unknown type of message."))}}else this.logger.debug("Received message for unknown subscription ID: "+o)}},t.prototype.validateMessage=function(e){return Array.isArray(e)?e.length<1?new s.ProtocolError("Message is empty array: "+JSON.stringify(e)):null:new s.ProtocolError("Message is expected to be an array. Getting: "+JSON.stringify(e))},t.prototype.onOpenMessage=function(e,t,r){r.onOpen&&r.onOpen(e[1])},t.prototype.onEventMessage=function(e,t){if(3===e.length){var r=e[0],n=e[1],o=e[2];"string"==typeof r?"object"!=typeof n||Array.isArray(n)?t.onError&&t.onError(new s.ProtocolError("Invalid event headers in message: "+JSON.stringify(e))):t.onEvent&&t.onEvent({eventId:r,headers:n,body:o}):t.onError&&t.onError(new s.ProtocolError("Invalid event ID in message: "+JSON.stringify(e)))}else t.onError&&t.onError(new s.ProtocolError("Event message has "+e.length+" elements (expected 4)"))},t.prototype.onEOSMessage=function(e,t,r){if(this.subscriptions.remove(t),3===e.length){var n=e[0],o=e[1],i=e[2];"number"==typeof n?"object"!=typeof o||Array.isArray(o)?r.onError&&r.onError(new s.ProtocolError("Invalid EOS ElementsHeaders")):204!==n?r.onError&&r.onError(new s.ErrorResponse(n,o,i)):r.onEnd&&r.onEnd(null):r.onError&&r.onError(new s.ProtocolError("Invalid EOS Status Code"))}else r.onError&&r.onError(new s.ProtocolError("EOS message has "+e.length+" elements (expected 4)"))},t.prototype.onCloseMessage=function(e){var t=e[0],r=e[1],n=e[2];if("number"==typeof t)if("object"!=typeof r||Array.isArray(r))this.close(new s.ProtocolError("Close message: Invalid EOS ElementsHeaders"));else{var o={error:n.error||"network_error",error_description:n.error_description||"Network error"};this.close(new s.ErrorResponse(t,r,o))}else this.close(new s.ProtocolError("Close message: Invalid EOS Status Code"))},t.prototype.onPongMessage=function(t){var r=t[0];this.lastSentPingID!==r&&this.close(new s.ProtocolError("Received pong with ID "+r+" but last sent ping ID was "+this.lastSentPingID)),e.clearTimeout(this.pongTimeout),delete this.pongTimeout,this.lastSentPingID=null},t.prototype.onPingMessage=function(e){var t=e[0];this.sendMessage(this.getMessage(17,t))},t}();t.default=u}).call(t,r(1))},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(4),o=r(10),s=r(2),i=function(){function e(e){if(!e.locator)throw new Error("Expected `locator` property in Instance options!");var t=e.locator.split(":");if(3!==t.length)throw new Error("The instance locator supplied is invalid. Did you copy it correctly from the Pusher dashboard?");if(!e.serviceName)throw new Error("Expected `serviceName` property in Instance options!");if(!e.serviceVersion)throw new Error("Expected `serviceVersion` property in Instance options!");this.platformVersion=t[0],this.cluster=t[1],this.id=t[2],this.serviceName=e.serviceName,this.serviceVersion=e.serviceVersion,this.host=e.host||this.cluster+"."+o.HOST_BASE,this.logger=e.logger||new s.ConsoleLogger,this.client=e.client||new n.BaseClient({encrypted:e.encrypted,host:this.host,logger:this.logger}),this.tokenProvider=e.tokenProvider}return e.prototype.request=function(e,t){return e.path=this.absPath(e.path),null!=e.headers&&void 0!==e.headers||(e.headers={}),e.tokenProvider=e.tokenProvider||this.tokenProvider,this.client.request(e,t)},e.prototype.subscribeNonResuming=function(e){var t=e.headers||{},r=e.retryStrategyOptions||{},n=e.tokenProvider||this.tokenProvider;return this.client.subscribeNonResuming(this.absPath(e.path),t,e.listeners,r,n)},e.prototype.subscribeResuming=function(e){var t=e.headers||{},r=e.retryStrategyOptions||{},n=e.tokenProvider||this.tokenProvider;return this.client.subscribeResuming(this.absPath(e.path),t,e.listeners,r,e.initialEventId,n)},e.prototype.absPath=function(e){return("/services/"+this.serviceName+"/"+this.serviceVersion+"/"+this.id+"/"+e).replace(/\/+/g,"/").replace(/\/+$/,"")},e}();t.default=i}])});unwrapExports(pusherPlatform);var reactNative=pusherPlatform,reactNative_1=reactNative.BaseClient,reactNative_2=reactNative.HOST_BASE,reactNative_3=reactNative.Instance,reactNative_4=reactNative.sendRawRequest;function _isPlaceholder(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function _curry1(e){return function t(r){return 0===arguments.length||_isPlaceholder(r)?t:e.apply(this,arguments)}}var always=_curry1(function(e){return function(){return e}}),F=always(!1),T=always(!0);function _curry2(e){return function t(r,n){switch(arguments.length){case 0:return t;case 1:return _isPlaceholder(r)?t:_curry1(function(t){return e(r,t)});default:return _isPlaceholder(r)&&_isPlaceholder(n)?t:_isPlaceholder(r)?_curry1(function(t){return e(t,n)}):_isPlaceholder(n)?_curry1(function(t){return e(r,t)}):e(r,n)}}}var add=_curry2(function(e,t){return Number(e)+Number(t)});function _concat(e,t){var r;e=e||[],t=t||[];var n=e.length,o=t.length,s=[];for(r=0;r<n;)s[s.length]=e[r],r+=1;for(r=0;r<o;)s[s.length]=t[r],r+=1;return s}function _arity(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,r){return t.apply(this,arguments)};case 3:return function(e,r,n){return t.apply(this,arguments)};case 4:return function(e,r,n,o){return t.apply(this,arguments)};case 5:return function(e,r,n,o,s){return t.apply(this,arguments)};case 6:return function(e,r,n,o,s,i){return t.apply(this,arguments)};case 7:return function(e,r,n,o,s,i,a){return t.apply(this,arguments)};case 8:return function(e,r,n,o,s,i,a,u){return t.apply(this,arguments)};case 9:return function(e,r,n,o,s,i,a,u,c){return t.apply(this,arguments)};case 10:return function(e,r,n,o,s,i,a,u,c,h){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}function _curryN(e,t,r){return function(){for(var n=[],o=0,s=e,i=0;i<t.length||o<arguments.length;){var a;i<t.length&&(!_isPlaceholder(t[i])||o>=arguments.length)?a=t[i]:(a=arguments[o],o+=1),n[i]=a,_isPlaceholder(a)||(s-=1),i+=1}return s<=0?r.apply(this,n):_arity(s,_curryN(e,n,r))}}var curryN=_curry2(function(e,t){return 1===e?_curry1(t):_arity(e,_curryN(e,[],t))});function _curry3(e){return function t(r,n,o){switch(arguments.length){case 0:return t;case 1:return _isPlaceholder(r)?t:_curry2(function(t,n){return e(r,t,n)});case 2:return _isPlaceholder(r)&&_isPlaceholder(n)?t:_isPlaceholder(r)?_curry2(function(t,r){return e(t,n,r)}):_isPlaceholder(n)?_curry2(function(t,n){return e(r,t,n)}):_curry1(function(t){return e(r,n,t)});default:return _isPlaceholder(r)&&_isPlaceholder(n)&&_isPlaceholder(o)?t:_isPlaceholder(r)&&_isPlaceholder(n)?_curry2(function(t,r){return e(t,r,o)}):_isPlaceholder(r)&&_isPlaceholder(o)?_curry2(function(t,r){return e(t,n,r)}):_isPlaceholder(n)&&_isPlaceholder(o)?_curry2(function(t,n){return e(r,t,n)}):_isPlaceholder(r)?_curry1(function(t){return e(t,n,o)}):_isPlaceholder(n)?_curry1(function(t){return e(r,t,o)}):_isPlaceholder(o)?_curry1(function(t){return e(r,n,t)}):e(r,n,o)}}}var _isArray=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)};function _isTransformer(e){return"function"==typeof e["@@transducer/step"]}function _dispatchable(e,t,r){return function(){if(0===arguments.length)return r();var n=Array.prototype.slice.call(arguments,0),o=n.pop();if(!_isArray(o)){for(var s=0;s<e.length;){if("function"==typeof o[e[s]])return o[e[s]].apply(o,n);s+=1}if(_isTransformer(o))return t.apply(null,n)(o)}return r.apply(this,arguments)}}var _xfBase={init:function(){return this.xf["@@transducer/init"]()},result:function(e){return this.xf["@@transducer/result"](e)}},max=_curry2(function(e,t){return t>e?t:e});function _map(e,t){for(var r=0,n=t.length,o=Array(n);r<n;)o[r]=e(t[r]),r+=1;return o}function _isString(e){return"[object String]"===Object.prototype.toString.call(e)}var _isArrayLike=_curry1(function(e){return!!_isArray(e)||!!e&&("object"==typeof e&&(!_isString(e)&&(1===e.nodeType?!!e.length:0===e.length||e.length>0&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))}),XWrap=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},e}();function _xwrap(e){return new XWrap(e)}var bind=_curry2(function(e,t){return _arity(e.length,function(){return e.apply(t,arguments)})});function _arrayReduce(e,t,r){for(var n=0,o=r.length;n<o;){if((t=e["@@transducer/step"](t,r[n]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}n+=1}return e["@@transducer/result"](t)}function _iterableReduce(e,t,r){for(var n=r.next();!n.done;){if((t=e["@@transducer/step"](t,n.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}n=r.next()}return e["@@transducer/result"](t)}function _methodReduce(e,t,r,n){return e["@@transducer/result"](r[n](bind(e["@@transducer/step"],e),t))}var symIterator="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";function _reduce(e,t,r){if("function"==typeof e&&(e=_xwrap(e)),_isArrayLike(r))return _arrayReduce(e,t,r);if("function"==typeof r["fantasy-land/reduce"])return _methodReduce(e,t,r,"fantasy-land/reduce");if(null!=r[symIterator])return _iterableReduce(e,t,r[symIterator]());if("function"==typeof r.next)return _iterableReduce(e,t,r);if("function"==typeof r.reduce)return _methodReduce(e,t,r,"reduce");throw new TypeError("reduce: list must be array or iterable")}var XMap=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=_xfBase.init,e.prototype["@@transducer/result"]=_xfBase.result,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},e}(),_xmap=_curry2(function(e,t){return new XMap(e,t)});function _has(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var toString=Object.prototype.toString,_isArguments=function(){return"[object Arguments]"===toString.call(arguments)?function(e){return"[object Arguments]"===toString.call(e)}:function(e){return _has("callee",e)}},hasEnumBug=!{toString:null}.propertyIsEnumerable("toString"),nonEnumerableProps=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],hasArgsEnumBug=function(){return arguments.propertyIsEnumerable("length")}(),contains=function(e,t){for(var r=0;r<e.length;){if(e[r]===t)return!0;r+=1}return!1},_keys="function"!=typeof Object.keys||hasArgsEnumBug?function(e){if(Object(e)!==e)return[];var t,r,n=[],o=hasArgsEnumBug&&_isArguments(e);for(t in e)!_has(t,e)||o&&"length"===t||(n[n.length]=t);if(hasEnumBug)for(r=nonEnumerableProps.length-1;r>=0;)_has(t=nonEnumerableProps[r],e)&&!contains(n,t)&&(n[n.length]=t),r-=1;return n}:function(e){return Object(e)!==e?[]:Object.keys(e)},keys=_curry1(_keys),map=_curry2(_dispatchable(["fantasy-land/map","map"],_xmap,function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return curryN(t.length,function(){return e.call(this,t.apply(this,arguments))});case"[object Object]":return _reduce(function(r,n){return r[n]=e(t[n]),r},{},keys(t));default:return _map(e,t)}})),path=_curry2(function(e,t){for(var r=t,n=0;n<e.length;){if(null==r)return;r=r[e[n]],n+=1}return r}),prop=_curry2(function(e,t){return path([e],t)}),pluck=_curry2(function(e,t){return map(prop(e),t)}),reduce=_curry3(_reduce),ap=_curry2(function(e,t){return"function"==typeof t["fantasy-land/ap"]?t["fantasy-land/ap"](e):"function"==typeof e.ap?e.ap(t):"function"==typeof e?function(r){return e(r)(t(r))}:_reduce(function(e,r){return _concat(e,map(r,t))},[],e)}),append=_curry2(function(e,t){return _concat(t,[e])}),values=_curry1(function(e){for(var t=keys(e),r=t.length,n=[],o=0;o<r;)n[o]=e[t[o]],o+=1;return n});function _isFunction(e){return"[object Function]"===Object.prototype.toString.call(e)}var liftN=_curry2(function(e,t){var r=curryN(e,t);return curryN(e,function(){return _reduce(ap,map(r,arguments[0]),Array.prototype.slice.call(arguments,1))})}),lift=_curry1(function(e){return liftN(e.length,e)}),curry=_curry1(function(e){return curryN(e.length,e)}),call=curry(function(e){return e.apply(this,Array.prototype.slice.call(arguments,1))});function _makeFlat(e){return function t(r){for(var n,o,s,i=[],a=0,u=r.length;a<u;){if(_isArrayLike(r[a]))for(s=0,o=(n=e?t(r[a]):r[a]).length;s<o;)i[i.length]=n[s],s+=1;else i[i.length]=r[a];a+=1}return i}}function _forceReduced(e){return{"@@transducer/value":e,"@@transducer/reduced":!0}}var preservingReduced=function(e){return{"@@transducer/init":_xfBase.init,"@@transducer/result":function(t){return e["@@transducer/result"](t)},"@@transducer/step":function(t,r){var n=e["@@transducer/step"](t,r);return n["@@transducer/reduced"]?_forceReduced(n):n}}},_flatCat=function(e){var t=preservingReduced(e);return{"@@transducer/init":_xfBase.init,"@@transducer/result":function(e){return t["@@transducer/result"](e)},"@@transducer/step":function(e,r){return _isArrayLike(r)?_reduce(t,e,r):_reduce(t,e,[r])}}},_xchain=_curry2(function(e,t){return map(e,_flatCat(t))}),chain=_curry2(_dispatchable(["fantasy-land/chain","chain"],_xchain,function(e,t){return"function"==typeof t?function(r){return e(t(r))(r)}:_makeFlat(!1)(map(e,t))})),type=_curry1(function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}),not=_curry1(function(e){return!e}),complement=lift(not);function _pipe(e,t){return function(){return t.call(this,e.apply(this,arguments))}}function _checkForMethod(e,t){return function(){var r=arguments.length;if(0===r)return t();var n=arguments[r-1];return _isArray(n)||"function"!=typeof n[e]?t.apply(this,arguments):n[e].apply(n,Array.prototype.slice.call(arguments,0,r-1))}}var slice=_curry3(_checkForMethod("slice",function(e,t,r){return Array.prototype.slice.call(r,e,t)})),tail=_curry1(_checkForMethod("tail",slice(1,1/0)));function pipe(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return _arity(arguments[0].length,reduce(_pipe,arguments[0],tail(arguments)))}var reverse=_curry1(function(e){return _isString(e)?e.split("").reverse().join(""):Array.prototype.slice.call(e,0).reverse()});function compose(){if(0===arguments.length)throw new Error("compose requires at least one argument");return pipe.apply(this,reverse(arguments))}function _arrayFromIterator(e){for(var t,r=[];!(t=e.next()).done;)r.push(t.value);return r}function _containsWith(e,t,r){for(var n=0,o=r.length;n<o;){if(e(t,r[n]))return!0;n+=1}return!1}function _functionName(e){var t=String(e).match(/^function (\w*)/);return null==t?"":t[1]}var identical=_curry2(function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t});function _uniqContentEquals(e,t,r,n){var o=_arrayFromIterator(e);function s(e,t){return _equals(e,t,r.slice(),n.slice())}return!_containsWith(function(e,t){return!_containsWith(s,t,e)},_arrayFromIterator(t),o)}function _equals(e,t,r,n){if(identical(e,t))return!0;var o=type(e);if(o!==type(t))return!1;if(null==e||null==t)return!1;if("function"==typeof e["fantasy-land/equals"]||"function"==typeof t["fantasy-land/equals"])return"function"==typeof e["fantasy-land/equals"]&&e["fantasy-land/equals"](t)&&"function"==typeof t["fantasy-land/equals"]&&t["fantasy-land/equals"](e);if("function"==typeof e.equals||"function"==typeof t.equals)return"function"==typeof e.equals&&e.equals(t)&&"function"==typeof t.equals&&t.equals(e);switch(o){case"Arguments":case"Array":case"Object":if("function"==typeof e.constructor&&"Promise"===_functionName(e.constructor))return e===t;break;case"Boolean":case"Number":case"String":if(typeof e!=typeof t||!identical(e.valueOf(),t.valueOf()))return!1;break;case"Date":if(!identical(e.valueOf(),t.valueOf()))return!1;break;case"Error":return e.name===t.name&&e.message===t.message;case"RegExp":if(e.source!==t.source||e.global!==t.global||e.ignoreCase!==t.ignoreCase||e.multiline!==t.multiline||e.sticky!==t.sticky||e.unicode!==t.unicode)return!1}for(var s=r.length-1;s>=0;){if(r[s]===e)return n[s]===t;s-=1}switch(o){case"Map":return e.size===t.size&&_uniqContentEquals(e.entries(),t.entries(),r.concat([e]),n.concat([t]));case"Set":return e.size===t.size&&_uniqContentEquals(e.values(),t.values(),r.concat([e]),n.concat([t]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var i=keys(e);if(i.length!==keys(t).length)return!1;var a=r.concat([e]),u=n.concat([t]);for(s=i.length-1;s>=0;){var c=i[s];if(!_has(c,t)||!_equals(t[c],e[c],a,u))return!1;s-=1}return!0}var equals=_curry2(function(e,t){return _equals(e,t,[],[])});function _indexOf(e,t,r){var n,o;if("function"==typeof e.indexOf)switch(typeof t){case"number":if(0===t){for(n=1/t;r<e.length;){if(0===(o=e[r])&&1/o===n)return r;r+=1}return-1}if(t!=t){for(;r<e.length;){if("number"==typeof(o=e[r])&&o!=o)return r;r+=1}return-1}return e.indexOf(t,r);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,r);case"object":if(null===t)return e.indexOf(t,r)}for(;r<e.length;){if(equals(e[r],t))return r;r+=1}return-1}function _contains(e,t){return _indexOf(t,e,0)>=0}function _quote(e){return'"'+e.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0").replace(/"/g,'\\"')+'"'}var pad=function(e){return(e<10?"0":"")+e},_toISOString="function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+pad(e.getUTCMonth()+1)+"-"+pad(e.getUTCDate())+"T"+pad(e.getUTCHours())+":"+pad(e.getUTCMinutes())+":"+pad(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"};function _complement(e){return function(){return!e.apply(this,arguments)}}function _filter(e,t){for(var r=0,n=t.length,o=[];r<n;)e(t[r])&&(o[o.length]=t[r]),r+=1;return o}function _isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}var XFilter=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=_xfBase.init,e.prototype["@@transducer/result"]=_xfBase.result,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},e}(),_xfilter=_curry2(function(e,t){return new XFilter(e,t)}),filter=_curry2(_dispatchable(["filter"],_xfilter,function(e,t){return _isObject(t)?_reduce(function(r,n){return e(t[n])&&(r[n]=t[n]),r},{},keys(t)):_filter(e,t)})),reject=_curry2(function(e,t){return filter(_complement(e),t)});function _toString(e,t){var r=function(r){var n=t.concat([e]);return _contains(r,n)?"<Circular>":_toString(r,n)},n=function(e,t){return _map(function(t){return _quote(t)+": "+r(e[t])},t.slice().sort())};switch(Object.prototype.toString.call(e)){case"[object Arguments]":return"(function() { return arguments; }("+_map(r,e).join(", ")+"))";case"[object Array]":return"["+_map(r,e).concat(n(e,reject(function(e){return/^\d+$/.test(e)},keys(e)))).join(", ")+"]";case"[object Boolean]":return"object"==typeof e?"new Boolean("+r(e.valueOf())+")":e.toString();case"[object Date]":return"new Date("+(isNaN(e.valueOf())?r(NaN):_quote(_toISOString(e)))+")";case"[object Null]":return"null";case"[object Number]":return"object"==typeof e?"new Number("+r(e.valueOf())+")":1/e==-1/0?"-0":e.toString(10);case"[object String]":return"object"==typeof e?"new String("+r(e.valueOf())+")":_quote(e);case"[object Undefined]":return"undefined";default:if("function"==typeof e.toString){var o=e.toString();if("[object Object]"!==o)return o}return"{"+n(e,keys(e)).join(", ")+"}"}}var toString$1=_curry1(function(e){return _toString(e,[])}),contains$1=_curry2(_contains),converge=_curry2(function(e,t){return curryN(reduce(max,0,pluck("length",t)),function(){var r=arguments,n=this;return e.apply(n,_map(function(e){return e.apply(n,r)},t))})}),XReduceBy=function(){function e(e,t,r,n){this.valueFn=e,this.valueAcc=t,this.keyFn=r,this.xf=n,this.inputs={}}return e.prototype["@@transducer/init"]=_xfBase.init,e.prototype["@@transducer/result"]=function(e){var t;for(t in this.inputs)if(_has(t,this.inputs)&&(e=this.xf["@@transducer/step"](e,this.inputs[t]))["@@transducer/reduced"]){e=e["@@transducer/value"];break}return this.inputs=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var r=this.keyFn(t);return this.inputs[r]=this.inputs[r]||[r,this.valueAcc],this.inputs[r][1]=this.valueFn(this.inputs[r][1],t),e},e}(),_xreduceBy=_curryN(4,[],function(e,t,r,n){return new XReduceBy(e,t,r,n)}),reduceBy=_curryN(4,[],_dispatchable([],_xreduceBy,function(e,t,r,n){return _reduce(function(n,o){var s=r(o);return n[s]=e(_has(s,n)?n[s]:t,o),n},{},n)})),countBy=reduceBy(function(e,t){return e+1},0),dec=add(-1),difference=_curry2(function(e,t){for(var r=[],n=0,o=e.length;n<o;)_contains(e[n],t)||_contains(e[n],r)||(r[r.length]=e[n]),n+=1;return r}),XDropRepeatsWith=function(){function e(e,t){this.xf=t,this.pred=e,this.lastValue=void 0,this.seenFirstValue=!1}return e.prototype["@@transducer/init"]=_xfBase.init,e.prototype["@@transducer/result"]=_xfBase.result,e.prototype["@@transducer/step"]=function(e,t){var r=!1;return this.seenFirstValue?this.pred(this.lastValue,t)&&(r=!0):this.seenFirstValue=!0,this.lastValue=t,r?e:this.xf["@@transducer/step"](e,t)},e}(),_xdropRepeatsWith=_curry2(function(e,t){return new XDropRepeatsWith(e,t)}),nth=_curry2(function(e,t){var r=e<0?t.length+e:e;return _isString(t)?t.charAt(r):t[r]}),last=nth(-1),dropRepeatsWith=_curry2(_dispatchable([],_xdropRepeatsWith,function(e,t){var r=[],n=1,o=t.length;if(0!==o)for(r[0]=t[0];n<o;)e(last(r),t[n])||(r[r.length]=t[n]),n+=1;return r})),dropRepeats=_curry1(_dispatchable([],_xdropRepeatsWith(equals),dropRepeatsWith(equals))),flip=_curry1(function(e){return curryN(e.length,function(t,r){var n=Array.prototype.slice.call(arguments,0);return n[0]=r,n[1]=t,e.apply(this,n)})}),forEach=_curry2(_checkForMethod("forEach",function(e,t){for(var r=t.length,n=0;n<r;)e(t[n]),n+=1;return t})),forEachObjIndexed=_curry2(function(e,t){for(var r=keys(t),n=0;n<r.length;){var o=r[n];e(t[o],o,t),n+=1}return t}),groupBy=_curry2(_checkForMethod("groupBy",reduceBy(function(e,t){return null==e&&(e=[]),e.push(t),e},null))),has=_curry2(_has),head=nth(0);function _identity(e){return e}var identity=_curry1(_identity),inc=add(1),indexBy=reduceBy(function(e,t){return t},null),init=slice(0,-1),_Set=function(){function e(){this._nativeSet="function"==typeof Set?new Set:null,this._items={}}return e.prototype.add=function(e){return!hasOrAdd(e,!0,this)},e.prototype.has=function(e){return hasOrAdd(e,!1,this)},e}();function hasOrAdd(e,t,r){var n,o=typeof e;switch(o){case"string":case"number":return 0===e&&1/e==-1/0?!!r._items["-0"]||(t&&(r._items["-0"]=!0),!1):null!==r._nativeSet?t?(n=r._nativeSet.size,r._nativeSet.add(e),r._nativeSet.size===n):r._nativeSet.has(e):o in r._items?e in r._items[o]||(t&&(r._items[o][e]=!0),!1):(t&&(r._items[o]={},r._items[o][e]=!0),!1);case"boolean":if(o in r._items){var s=e?1:0;return!!r._items[o][s]||(t&&(r._items[o][s]=!0),!1)}return t&&(r._items[o]=e?[!1,!0]:[!0,!1]),!1;case"function":return null!==r._nativeSet?t?(n=r._nativeSet.size,r._nativeSet.add(e),r._nativeSet.size===n):r._nativeSet.has(e):o in r._items?!!_contains(e,r._items[o])||(t&&r._items[o].push(e),!1):(t&&(r._items[o]=[e]),!1);case"undefined":return!!r._items[o]||(t&&(r._items[o]=!0),!1);case"object":if(null===e)return!!r._items.null||(t&&(r._items.null=!0),!1);default:return(o=Object.prototype.toString.call(e))in r._items?!!_contains(e,r._items[o])||(t&&r._items[o].push(e),!1):(t&&(r._items[o]=[e]),!1)}}var uniqBy=_curry2(function(e,t){for(var r,n,o=new _Set,s=[],i=0;i<t.length;)r=e(n=t[i]),o.add(r)&&s.push(n),i+=1;return s}),uniq=uniqBy(identity),invoker=_curry2(function(e,t){return curryN(e+1,function(){var r=arguments[e];if(null!=r&&_isFunction(r[t]))return r[t].apply(r,Array.prototype.slice.call(arguments,0,e));throw new TypeError(toString$1(r)+' does not have a method named "'+t+'"')})}),join=invoker(1,"join"),juxt=_curry1(function(e){return converge(function(){return Array.prototype.slice.call(arguments,0)},e)}),sum=reduce(add,0),memoizeWith=_curry2(function(e,t){var r={};return _arity(t.length,function(){var n=e.apply(this,arguments);return _has(n,r)||(r[n]=t.apply(this,arguments)),r[n]})}),memoize=memoizeWith(function(){return toString$1(arguments)}),multiply=_curry2(function(e,t){return e*t});function _createPartialApplicator(e){return _curry2(function(t,r){return _arity(Math.max(0,t.length-r.length),function(){return t.apply(this,e(r,arguments))})})}var partialRight=_createPartialApplicator(flip(_concat)),partition=juxt([filter,reject]),pickAll=_curry2(function(e,t){for(var r={},n=0,o=e.length;n<o;){var s=e[n];r[s]=t[s],n+=1}return r}),product=reduce(multiply,1),useWith=_curry2(function(e,t){return curryN(t.length,function(){for(var r=[],n=0;n<t.length;)r.push(t[n].call(this,arguments[n])),n+=1;return e.apply(this,r.concat(Array.prototype.slice.call(arguments,t.length)))})}),project=useWith(_map,[pickAll,identity]),sort=_curry2(function(e,t){return Array.prototype.slice.call(t,0).sort(e)}),split=invoker(1,"split"),toLower=invoker(0,"toLowerCase"),toPairs=_curry1(function(e){var t=[];for(var r in e)_has(r,e)&&(t[t.length]=[r,e[r]]);return t}),toUpper=invoker(0,"toUpperCase"),transduce=curryN(4,function(e,t,r,n){return _reduce(e("function"==typeof t?_xwrap(t):t),r,n)}),ws="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff",zeroWidth="​",hasProtoTrim="function"==typeof String.prototype.trim,_trim=hasProtoTrim&&!ws.trim()&&zeroWidth.trim()?function(e){return e.trim()}:function(e){var t=new RegExp("^["+ws+"]["+ws+"]*"),r=new RegExp("["+ws+"]["+ws+"]*$");return e.replace(t,"").replace(r,"")},union=_curry2(compose(uniq,_concat)),unnest=chain(_identity),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},objectWithoutProperties=function(e,t){var r={};for(var n in e)t.indexOf(n)>=0||Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r},slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,s=void 0;try{for(var i,a=e[Symbol.iterator]();!(n=(i=a.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,s=e}finally{try{!n&&a.return&&a.return()}finally{if(o)throw s}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)},urlEncode=pipe(filter(function(e){return void 0!==e}),toPairs,map(function(e){var t=slicedToArray(e,2),r=t[0],n=t[1];return r+"="+encodeURIComponent(n)}),join("&")),appendQueryParams=function(e,t){return t+(contains$1("?",t)?"&":"?")+urlEncode(e)},appendQueryParamsAsArray=function(e,t,r){var n=contains$1("?",r)?"":"?",o=map(function(t){return encodeURIComponent(e)+"="+encodeURIComponent(t)},t);return r+n+join("&",o)},typeCheck=function(e,t,r){var n=void 0===r?"undefined":_typeof(r);if(n!==t)throw new TypeError("expected "+e+" to be of type "+t+" but was of type "+n)},typeCheckArr=function(e,t,r){if(!Array.isArray(r))throw new TypeError("expected "+e+" to be an array");r.forEach(function(r,n){return typeCheck(e+"["+n+"]",t,r)})},typeCheckObj=function(e,t,r){typeCheck(e,"object",r),forEachObjIndexed(function(r,n){return typeCheck(e+"."+n,t,r)},r)},checkOneOf=function(e,t,r){if(!contains$1(r,t))throw new TypeError("expected "+e+" to be one of "+t+" but was "+r)},unixSeconds=function(){return Math.floor(Date.now()/1e3)},TokenProvider=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.url,n=t.queryParams,o=t.headers,s=t.withCredentials;classCallCheck(this,e),typeCheck("url","string",r),n&&typeCheck("queryParams","object",n),o&&typeCheck("headers","object",o),this.url=r,this.queryParams=n,this.headers=o,this.withCredentials=s,this.fetchToken=this.fetchToken.bind(this),this.fetchFreshToken=this.fetchFreshToken.bind(this),this.cacheIsStale=this.cacheIsStale.bind(this),this.cache=this.cache.bind(this),this.clearCache=this.clearCache.bind(this),this.setUserId=this.setUserId.bind(this)}return createClass(e,[{key:"fetchToken",value:function(){var e=this;return this.cacheIsStale()?(this.req||this.fetchFreshToken()).then(function(t){var r=t.token,n=t.expiresIn;return e.cache(r,n),r}):Promise.resolve(this.cachedToken)}},{key:"fetchFreshToken",value:function(){var e=this;return this.req=reactNative_4({method:"POST",url:appendQueryParams(_extends({user_id:this.userId},this.queryParams),this.url),body:urlEncode({grant_type:"client_credentials"}),headers:_extends({"content-type":"application/x-www-form-urlencoded"},this.headers),withCredentials:this.withCredentials}).then(function(t){var r=JSON.parse(t),n=r.access_token,o=r.expires_in;return delete e.req,{token:n,expiresIn:o}}).catch(function(t){throw delete e.req,t}),this.req}},{key:"cacheIsStale",value:function(){return!this.cachedToken||unixSeconds()>this.cacheExpiresAt}},{key:"cache",value:function(e,t){this.cachedToken=e,this.cacheExpiresAt=unixSeconds()+t}},{key:"clearCache",value:function(){this.cachedToken=void 0,this.cacheExpiresAt=void 0}},{key:"setUserId",value:function(e){this.clearCache(),this.userId=e}}]),e}(),parseBasicRoom=function(e){return{createdAt:e.created_at,createdByUserId:e.created_by_id,id:e.id,isPrivate:e.private,name:e.name,updatedAt:e.updated_at,customData:e.custom_data,deletedAt:e.deleted_at,unreadCount:e.unread_count,lastMessageAt:e.last_message_at}},parseBasicUser=function(e){return{avatarURL:e.avatar_url,createdAt:e.created_at,customData:e.custom_data,id:e.id,name:e.name,updatedAt:e.updated_at}},parsePresence=function(e){return{state:["online","offline"].includes(e.state)?e.state:"unknown"}},parseBasicMessage=function(e){var t={roomId:e.room_id,id:e.id,senderId:e.user_id,createdAt:e.created_at,updatedAt:e.updated_at};return e.parts?t.parts=e.parts.map(function(e){return parseMessagePart(e)}):(t.text=e.text,e.attachment&&(t.attachment=parseMessageAttachment(e.attachment))),t},parseBasicCursor=function(e){return{position:e.position,updatedAt:e.updated_at,userId:e.user_id,roomId:e.room_id,type:e.cursor_type}},parseMessageAttachment=function(e){return{link:e.resource_link,type:e.type,name:e.name}},parseMessagePart=function(e){if(e.content)return{partType:"inline",payload:{type:e.type,content:e.content}};if(e.url)return{partType:"url",payload:{type:e.type,url:e.url}};if(e.attachment)return{partType:"attachment",payload:{type:e.type,name:e.attachment.name,size:e.attachment.size,customData:e.attachment.custom_data,_id:e.attachment.id,_downloadURL:e.attachment.download_url,_expiration:new Date(e.attachment.expiration)}};throw new TypeError("failed to parse message part")},User=function(){function e(t,r){classCallCheck(this,e),this.avatarURL=t.avatarURL,this.createdAt=t.createdAt,this.customData=t.customData,this.id=t.id,this.name=t.name,this.updatedAt=t.updatedAt,this.presenceStore=r}return createClass(e,[{key:"presence",get:function(){return{state:this.presenceStore[this.id]||"unknown"}}}]),e}(),UserStore=function(){function e(t){var r=t.instance,n=t.presenceStore,o=t.logger;classCallCheck(this,e),this.instance=r,this.presenceStore=n,this.logger=o,this.reqs={},this.onSetHooks=[],this.users={},this.set=this.set.bind(this),this.get=this.get.bind(this),this.fetchMissingUsers=this.fetchMissingUsers.bind(this),this.fetchBasicUsers=this.fetchBasicUsers.bind(this),this.snapshot=this.snapshot.bind(this),this.getSync=this.getSync.bind(this),this.decorate=this.decorate.bind(this)}return createClass(e,[{key:"set",value:function(e){return this.users[e.id]=this.decorate(e),this.onSetHooks.forEach(function(t){return t(e.id)}),Promise.resolve(this.users[e.id])}},{key:"get",value:function(e){var t=this;return this.fetchMissingUsers([e]).then(function(){return t.users[e]})}},{key:"fetchMissingUsers",value:function(e){var t=this,r=difference(e,Object.values(this.users).map(function(e){return e.id})),n=difference(r,Object.keys(this.reqs));return n.length>0&&this.fetchBasicUsers(n),Promise.all(e.map(function(e){return t.reqs[e]}))}},{key:"fetchBasicUsers",value:function(e){var t=this,r=this.instance.request({method:"GET",path:appendQueryParamsAsArray("id",e,"/users_by_ids")}).then(function(r){JSON.parse(r).map(function(e){return parseBasicUser(e)}).forEach(function(e){return t.set(e)}),e.forEach(function(e){delete t.reqs[e]})}).catch(function(e){throw t.logger.warn("error fetching missing users:",e),e});e.forEach(function(e){t.reqs[e]=r})}},{key:"snapshot",value:function(){return this.users}},{key:"getSync",value:function(e){return this.users[e]}},{key:"decorate",value:function(e){return e?new User(e,this.presenceStore):void 0}}]),e}(),Room=function(){function e(t){var r=t.basicRoom,n=t.userStore,o=t.isSubscribedTo,s=t.logger;classCallCheck(this,e),this.createdAt=r.createdAt,this.createdByUserId=r.createdByUserId,this.deletedAt=r.deletedAt,this.id=r.id,this.isPrivate=r.isPrivate,this.name=r.name,this.updatedAt=r.updatedAt,this.customData=r.customData,this.unreadCount=r.unreadCount,this.lastMessageAt=r.lastMessageAt,this.userIds=[],this.userStore=n,this.isSubscribedTo=o,this.logger=s,this.eq=this.eq.bind(this)}return createClass(e,[{key:"eq",value:function(e){return this.createdAt===e.createdAt&&this.createdByUserId===e.createdByUserId&&this.deletedAt===e.deletedAt&&this.id===e.id&&this.isPrivate===e.isPrivate&&this.name===e.name&&this.updatedAt===e.updatedAt&&JSON.stringify(this.customData)===JSON.stringify(e.customData)}},{key:"users",get:function(){var e=this;if(!this.isSubscribedTo(this.id)){var t=new Error("Must be subscribed to room "+this.id+" to access users property");throw this.logger.error(t),t}return filter(function(t){return contains$1(t.id,e.userIds)},values(this.userStore.snapshot()))}}]),e}(),RoomStore=function(){function e(t){classCallCheck(this,e),this.instance=t.instance,this.userStore=t.userStore,this.isSubscribedTo=t.isSubscribedTo,this.logger=t.logger,this.rooms={},this.setSync=this.setSync.bind(this),this.set=this.set.bind(this),this.get=this.get.bind(this),this.popSync=this.popSync.bind(this),this.pop=this.pop.bind(this),this.addUserToRoom=this.addUserToRoom.bind(this),this.removeUserFromRoom=this.removeUserFromRoom.bind(this),this.updateSync=this.updateSync.bind(this),this.update=this.update.bind(this),this.fetchBasicRoom=this.fetchBasicRoom.bind(this),this.snapshot=this.snapshot.bind(this),this.getSync=this.getSync.bind(this),this.decorate=this.decorate.bind(this)}return createClass(e,[{key:"setSync",value:function(e){return this.rooms[e.id]||(this.rooms[e.id]=this.decorate(e)),this.rooms[e.id]}},{key:"set",value:function(e){return Promise.resolve(this.setSync(e))}},{key:"get",value:function(e){var t=this;return Promise.resolve(this.rooms[e]).then(function(r){return r||t.fetchBasicRoom(e).then(function(r){return t.set(e,r)})})}},{key:"popSync",value:function(e){var t=this.rooms[e];return delete this.rooms[e],t}},{key:"pop",value:function(e){return Promise.resolve(this.popSync(e))}},{key:"addUserToRoom",value:function(e,t){return Promise.all([this.get(e).then(function(e){return e.userIds=uniq(append(t,e.userIds)),e}),this.userStore.fetchMissingUsers([t])]).then(function(e){return slicedToArray(e,1)[0]})}},{key:"removeUserFromRoom",value:function(e,t){return this.get(e).then(function(e){return e.userIds=e.userIds.filter(function(e){return e!==t}),e})}},{key:"updateSync",value:function(e,t){var r=this.getSync(e);for(var n in t)r[n]=t[n];return r}},{key:"update",value:function(e,t){var r=this;return Promise.all([this.get(e).then(function(){return r.updateSync(e,t)}),this.userStore.fetchMissingUsers(t.userIds||[])]).then(function(e){return slicedToArray(e,1)[0]})}},{key:"fetchBasicRoom",value:function(e){var t=this;return this.instance.request({method:"GET",path:"/rooms/"+encodeURIComponent(e)}).then(pipe(JSON.parse,parseBasicRoom)).catch(function(r){t.logger.warn("error fetching details for room "+e+":",r)})}},{key:"snapshot",value:function(){return this.rooms}},{key:"getSync",value:function(e){return this.rooms[e]}},{key:"decorate",value:function(e){return e?new Room({basicRoom:e,userStore:this.userStore,isSubscribedTo:this.isSubscribedTo,logger:this.logger}):void 0}}]),e}(),Cursor=function(){function e(t,r,n){classCallCheck(this,e),this.position=t.position,this.updatedAt=t.updatedAt,this.userId=t.userId,this.roomId=t.roomId,this.type=t.type,this.userStore=r,this.roomStore=n}return createClass(e,[{key:"user",get:function(){return this.userStore.getSync(this.userId)}},{key:"room",get:function(){return this.roomStore.getSync(this.roomId)}}]),e}(),CursorStore=function(){function e(t){var r=t.instance,n=t.userStore,o=t.roomStore,s=t.logger;classCallCheck(this,e),this.instance=r,this.userStore=n,this.roomStore=o,this.logger=s,this.cursors={},this.set=this.set.bind(this),this.get=this.get.bind(this),this.getSync=this.getSync.bind(this),this.fetchBasicCursor=this.fetchBasicCursor.bind(this),this.decorate=this.decorate.bind(this)}return createClass(e,[{key:"set",value:function(e){var t=this,r=key(e.userId,e.roomId);return this.cursors[r]=this.decorate(e),this.userStore.fetchMissingUsers([e.userId]).then(function(){return t.cursors[r]})}},{key:"get",value:function(e,t){var r=this,n=key(e,t);return this.cursors[n]?Promise.resolve(this.cursors[n]):this.fetchBasicCursor(e,t).then(function(e){return r.set(e)})}},{key:"getSync",value:function(e,t){return this.cursors[key(e,t)]}},{key:"fetchBasicCursor",value:function(e,t){var r=this;return this.instance.request({method:"GET",path:"/cursors/0/rooms/"+encodeURIComponent(t)+"/users/"+encodeURIComponent(e)}).then(function(e){var t=JSON.parse(e);if(t)return parseBasicCursor(t)}).catch(function(e){throw r.logger.warn("error fetching cursor:",e),e})}},{key:"decorate",value:function(e){return e?new Cursor(e,this.userStore,this.roomStore):void 0}}]),e}(),key=function(e,t){return encodeURIComponent(e)+"/"+encodeURIComponent(t)},TYPING_INDICATOR_TTL=1500,TYPING_INDICATOR_LEEWAY=500,SET_CURSOR_WAIT=500,DEFAULT_CONNECTION_TIMEOUT=2e4,TypingIndicators=function(){function e(t){var r=t.hooks,n=t.instance,o=t.logger;classCallCheck(this,e),this.hooks=r,this.instance=n,this.logger=o,this.lastSentRequests={},this.timers={},this.sendThrottledRequest=this.sendThrottledRequest.bind(this),this.onIsTyping=this.onIsTyping.bind(this),this.onStarted=this.onStarted.bind(this),this.onStopped=this.onStopped.bind(this)}return createClass(e,[{key:"sendThrottledRequest",value:function(e){var t=this,r=Date.now(),n=this.lastSentRequests[e];return n&&r-n<TYPING_INDICATOR_TTL-TYPING_INDICATOR_LEEWAY?Promise.resolve():(this.lastSentRequests[e]=r,this.instance.request({method:"POST",path:"/rooms/"+encodeURIComponent(e)+"/typing_indicators"}).catch(function(r){throw delete t.typingRequestSent[e],t.logger.warn("Error sending typing indicator in room "+e,r),r}))}},{key:"onIsTyping",value:function(e,t){var r=this;this.timers[e.id]||(this.timers[e.id]={}),this.timers[e.id][t.id]?clearTimeout(this.timers[e.id][t.id]):this.onStarted(e,t),this.timers[e.id][t.id]=setTimeout(function(){r.onStopped(e,t),delete r.timers[e.id][t.id]},TYPING_INDICATOR_TTL)}},{key:"onStarted",value:function(e,t){this.hooks.global.onUserStartedTyping&&this.hooks.global.onUserStartedTyping(e,t),this.hooks.rooms[e.id]&&this.hooks.rooms[e.id].onUserStartedTyping&&this.hooks.rooms[e.id].onUserStartedTyping(t)}},{key:"onStopped",value:function(e,t){this.hooks.global.onUserStoppedTyping&&this.hooks.global.onUserStoppedTyping(e,t),this.hooks.rooms[e.id]&&this.hooks.rooms[e.id].onUserStoppedTyping&&this.hooks.rooms[e.id].onUserStoppedTyping(t)}}]),e}();function handleUserSubReconnection(e){var t=e.basicUser,r=e.basicRooms,n=e.basicCursors,o=e.currentUser,s=e.roomStore,i=e.cursorStore,a=e.hooks;o.setPropertiesFromBasicUser(t);var u=!0,c=!1,h=void 0;try{for(var l,d=r[Symbol.iterator]();!(u=(l=d.next()).done);u=!0){var p=l.value,f=s.getSync(p.id);if(!f){var g=s.setSync(p);a.global.onAddedToRoom&&a.global.onAddedToRoom(g)}f&&!f.eq(p)&&(s.updateSync(p.id,p),a.global.onRoomUpdated&&a.global.onRoomUpdated(f))}}catch(e){c=!0,h=e}finally{try{!u&&d.return&&d.return()}finally{if(c)throw h}}var m=function(e){if(!r.some(function(t){return t.id===e})){var t=s.popSync(e);a.global.onRemovedFromRoom&&a.global.onRemovedFromRoom(t)}};for(var y in s.snapshot())m(y);return handleCursorSubReconnection({basicCursors:n,cursorStore:i,onNewCursorHook:a.global.onNewReadCursor})}function handleMembershipSubReconnection(e){var t=e.userIds,r=e.roomId,n=e.roomStore,o=e.userStore,s=e.onUserJoinedRoomHook,i=e.onUserLeftRoomHook;return o.fetchMissingUsers(t).then(function(){var e=n.getSync(r);return t.filter(function(t){return!e.userIds.includes(t)}).forEach(function(t){return o.get(t).then(function(t){return s(e,t)})}),e.userIds.filter(function(e){return!t.includes(e)}).forEach(function(t){return o.get(t).then(function(t){return i(e,t)})}),n.update(r,{userIds:t})})}function handleCursorSubReconnection(e){var t=e.basicCursors,r=e.cursorStore,n=e.onNewCursorHook;return Promise.all(t.map(function(e){var t=r.getSync(e.userId,e.roomId);if(!t||t.position!==e.position)return r.set(e).then(function(e){n&&n(e)})}))}var UserSubscription=function(){function e(t){classCallCheck(this,e),this.userId=t.userId,this.hooks=t.hooks,this.instance=t.instance,this.roomStore=t.roomStore,this.cursorStore=t.cursorStore,this.roomSubscriptions=t.roomSubscriptions,this.logger=t.logger,this.connectionTimeout=t.connectionTimeout,this.currentUser=t.currentUser,this.connect=this.connect.bind(this),this.cancel=this.cancel.bind(this),this.onEvent=this.onEvent.bind(this),this.onInitialState=this.onInitialState.bind(this),this.onAddedToRoom=this.onAddedToRoom.bind(this),this.onRemovedFromRoom=this.onRemovedFromRoom.bind(this),this.onRoomUpdated=this.onRoomUpdated.bind(this),this.onRoomDeleted=this.onRoomDeleted.bind(this)}return createClass(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,r){e.timeout=setTimeout(function(){r(new Error("user subscription timed out"))},e.connectionTimeout),e.onSubscriptionEstablished=function(r){clearTimeout(e.timeout),t(r)},e.sub=e.instance.subscribeNonResuming({path:"/users",listeners:{onError:function(t){clearTimeout(e.timeout),r(t)},onEvent:e.onEvent}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling user subscription",e)}}},{key:"onEvent",value:function(e){var t=e.body;switch(t.event_name){case"initial_state":this.onInitialState(t.data);break;case"added_to_room":this.onAddedToRoom(t.data);break;case"removed_from_room":this.onRemovedFromRoom(t.data);break;case"room_updated":this.onRoomUpdated(t.data);break;case"room_deleted":this.onRoomDeleted(t.data);break;case"new_cursor":this.onNewCursor(t.data)}}},{key:"onInitialState",value:function(e){var t=e.current_user,r=e.rooms,n=e.cursors,o=parseBasicUser(t),s=r.map(function(e){return parseBasicRoom(e)}),i=n.map(function(e){return parseBasicCursor(e)});this.established?handleUserSubReconnection({basicUser:o,basicRooms:s,basicCursors:i,currentUser:this.currentUser,roomStore:this.roomStore,cursorStore:this.cursorStore,hooks:this.hooks}):(this.established=!0,this.onSubscriptionEstablished({basicUser:o,basicRooms:s,basicCursors:i}))}},{key:"onAddedToRoom",value:function(e){var t=this,r=e.room;this.roomStore.set(parseBasicRoom(r)).then(function(e){t.hooks.global.onAddedToRoom&&t.hooks.global.onAddedToRoom(e)})}},{key:"onRemovedFromRoom",value:function(e){var t=this,r=e.room_id;this.roomStore.pop(r).then(function(e){e&&t.hooks.global.onRemovedFromRoom&&t.hooks.global.onRemovedFromRoom(e)})}},{key:"onRoomUpdated",value:function(e){var t=this,r=e.room,n=parseBasicRoom(r);this.roomStore.update(n.id,n).then(function(e){t.hooks.global.onRoomUpdated&&t.hooks.global.onRoomUpdated(e)})}},{key:"onRoomDeleted",value:function(e){var t=this,r=e.room_id;this.roomStore.pop(r).then(function(e){e&&t.hooks.global.onRoomDeleted&&t.hooks.global.onRoomDeleted(e)})}},{key:"onNewCursor",value:function(e){var t=this;return this.cursorStore.set(parseBasicCursor(e)).then(function(e){t.hooks.global.onNewReadCursor&&0===e.type&&t.hooks.global.onNewReadCursor(e)})}}]),e}(),PresenceSubscription=function(){function e(t){classCallCheck(this,e),this.userId=t.userId,this.instance=t.instance,this.logger=t.logger,this.connectionTimeout=t.connectionTimeout}return createClass(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,r){e.timeout=setTimeout(function(){r(new Error("presence subscription timed out"))},e.connectionTimeout),e.sub=e.instance.subscribeNonResuming({path:"/users/"+encodeURIComponent(e.userId)+"/register",listeners:{onOpen:function(){clearTimeout(e.timeout),t()},onError:function(t){clearTimeout(e.timeout),r(t)}}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling presence subscription",e)}}}]),e}(),UserPresenceSubscription=function(){function e(t){classCallCheck(this,e),this.userId=t.userId,this.hooks=t.hooks,this.instance=t.instance,this.userStore=t.userStore,this.roomStore=t.roomStore,this.presenceStore=t.presenceStore,this.logger=t.logger,this.connectionTimeout=t.connectionTimeout,this.connect=this.connect.bind(this),this.cancel=this.cancel.bind(this),this.onEvent=this.onEvent.bind(this),this.onPresenceState=this.onPresenceState.bind(this)}return createClass(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,r){e.timeout=setTimeout(function(){r(new Error("user presence subscription timed out"))},e.connectionTimeout),e.onSubscriptionEstablished=function(){clearTimeout(e.timeout),t()},e.sub=e.instance.subscribeNonResuming({path:"/users/"+encodeURIComponent(e.userId),listeners:{onError:function(t){clearTimeout(e.timeout),r(t)},onEvent:e.onEvent}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling user presence subscription",e)}}},{key:"onEvent",value:function(e){var t=e.body;switch(t.event_name){case"presence_state":this.onPresenceState(t.data)}}},{key:"onPresenceState",value:function(e){var t=this;this.onSubscriptionEstablished();var r=this.presenceStore[this.userId]||"unknown",n=parsePresence(e).state;n!==r&&(this.presenceStore[this.userId]=n,this.userStore.get(this.userId).then(function(e){t.hooks.global.onPresenceChanged&&t.hooks.global.onPresenceChanged({current:n,previous:r},e),compose(forEach(function(o){var s=slicedToArray(o,2),i=s[0],a=s[1];return t.roomStore.get(i).then(function(t){contains$1(e.id,t.userIds)&&a.onPresenceChanged({current:n,previous:r},e)})}),filter(function(e){return void 0!==e[1].onPresenceChanged}),toPairs)(t.hooks.rooms)}))}}]),e}(),CursorSubscription=function(){function e(t){classCallCheck(this,e),this.onNewCursorHook=t.onNewCursorHook,this.roomId=t.roomId,this.cursorStore=t.cursorStore,this.instance=t.instance,this.logger=t.logger,this.connectionTimeout=t.connectionTimeout,this.connect=this.connect.bind(this),this.cancel=this.cancel.bind(this),this.onEvent=this.onEvent.bind(this),this.onInitialState=this.onInitialState.bind(this),this.onNewCursor=this.onNewCursor.bind(this)}return createClass(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,r){e.timeout=setTimeout(function(){r(new Error("cursor subscription timed out"))},e.connectionTimeout),e.onSubscriptionEstablished=function(r){clearTimeout(e.timeout),t(r)},e.sub=e.instance.subscribeNonResuming({path:"/cursors/0/rooms/"+encodeURIComponent(e.roomId),listeners:{onError:function(t){clearTimeout(e.timeout),r(t)},onEvent:e.onEvent}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling cursor subscription",e)}}},{key:"onEvent",value:function(e){var t=e.body;switch(t.event_name){case"initial_state":this.onInitialState(t.data);break;case"new_cursor":this.onNewCursor(t.data)}}},{key:"onInitialState",value:function(e){var t=this,r=e.cursors.map(function(e){return parseBasicCursor(e)});this.established?handleCursorSubReconnection({basicCursors:r,cursorStore:this.cursorStore,onNewCursorHook:this.onNewCursorHook}):(this.established=!0,Promise.all(r.map(function(e){return t.cursorStore.set(e)})).then(this.onSubscriptionEstablished))}},{key:"onNewCursor",value:function(e){var t=this;return this.cursorStore.set(parseBasicCursor(e)).then(function(e){return t.onNewCursorHook(e)})}}]),e}(),Attachment=function(){function e(t,r,n){classCallCheck(this,e),this.type=t.type,this.name=t.name,this.size=t.size,void 0!==t.customData&&(this.customData=t.customData),this._id=t._id,this._downloadURL=t._downloadURL,this._expiration=t._expiration,this._roomId=r,this._instance=n,this.url=this.url.bind(this),this.urlExpiry=this.urlExpiry.bind(this),this._fetchNewDownloadURL=this._fetchNewDownloadURL.bind(this)}return createClass(e,[{key:"url",value:function(){return this.urlExpiry().getTime()-Date.now()<18e5?this._fetchNewDownloadURL():Promise.resolve(this._downloadURL)}},{key:"urlExpiry",value:function(){return this._expiration}},{key:"_fetchNewDownloadURL",value:function(){var e=this;return this._instance.request({method:"GET",path:"rooms/"+encodeURIComponent(this._roomId)+"/attachments/"+this._id}).then(function(t){var r=JSON.parse(t),n=r.download_url,o=r.expiration;return e._downloadURL=n,e._expiration=new Date(o),e._downloadURL})}}]),e}(),Message=function(){function e(t,r,n,o){var s=this;classCallCheck(this,e),this.id=t.id,this.senderId=t.senderId,this.roomId=t.roomId,this.createdAt=t.createdAt,this.updatedAt=t.updatedAt,t.parts?this.parts=t.parts.map(function(e){var t=e.partType,r=e.payload;return"attachment"===t?{partType:t,payload:new Attachment(r,s.roomId,o)}:{partType:t,payload:r}}):(this.text=t.text,t.attachment&&(this.attachment=t.attachment)),this.userStore=r,this.roomStore=n}return createClass(e,[{key:"sender",get:function(){return this.userStore.getSync(this.senderId)}},{key:"room",get:function(){return this.roomStore.getSync(this.roomId)}}]),e}(),MessageSubscription=function(){function e(t){classCallCheck(this,e),this.roomId=t.roomId,this.messageLimit=t.messageLimit,this.userId=t.userId,this.instance=t.instance,this.userStore=t.userStore,this.roomStore=t.roomStore,this.typingIndicators=t.typingIndicators,this.messageBuffer=[],this.logger=t.logger,this.connectionTimeout=t.connectionTimeout,this.onMessageHook=t.onMessageHook,this.connect=this.connect.bind(this),this.cancel=this.cancel.bind(this),this.onEvent=this.onEvent.bind(this),this.onMessage=this.onMessage.bind(this),this.flushBuffer=this.flushBuffer.bind(this),this.onIsTyping=this.onIsTyping.bind(this)}return createClass(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,r){e.timeout=setTimeout(function(){r(new Error("message subscription timed out"))},e.connectionTimeout),e.sub=e.instance.subscribeResuming({path:"/rooms/"+encodeURIComponent(e.roomId)+"?"+urlEncode({message_limit:e.messageLimit}),listeners:{onOpen:function(){clearTimeout(e.timeout),t()},onError:function(t){clearTimeout(e.timeout),r(t)},onEvent:e.onEvent}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling message subscription",e)}}},{key:"onEvent",value:function(e){var t=e.body;switch(t.event_name){case"new_message":this.onMessage(t.data);break;case"is_typing":this.onIsTyping(t.data)}}},{key:"onMessage",value:function(e){var t=this,r={message:new Message(parseBasicMessage(e),this.userStore,this.roomStore,this.instance),ready:!1};this.messageBuffer.push(r),this.userStore.fetchMissingUsers([r.message.senderId]).catch(function(e){t.logger.error("error fetching missing user information:",e)}).then(function(){r.ready=!0,t.flushBuffer()})}},{key:"flushBuffer",value:function(){for(;this.messageBuffer.length>0&&this.messageBuffer[0].ready;)this.onMessageHook(this.messageBuffer.shift().message)}},{key:"onIsTyping",value:function(e){var t=this,r=e.user_id;r!==this.userId&&Promise.all([this.roomStore.get(this.roomId),this.userStore.get(r)]).then(function(e){var r=slicedToArray(e,2),n=r[0],o=r[1];return t.typingIndicators.onIsTyping(n,o)})}}]),e}(),MembershipSubscription=function(){function e(t){classCallCheck(this,e),this.roomId=t.roomId,this.instance=t.instance,this.userStore=t.userStore,this.roomStore=t.roomStore,this.logger=t.logger,this.connectionTimeout=t.connectionTimeout,this.onUserJoinedRoomHook=t.onUserJoinedRoomHook,this.onUserLeftRoomHook=t.onUserLeftRoomHook,this.connect=this.connect.bind(this),this.cancel=this.cancel.bind(this),this.onEvent=this.onEvent.bind(this),this.onInitialState=this.onInitialState.bind(this),this.onUserJoined=this.onUserJoined.bind(this),this.onUserLeft=this.onUserLeft.bind(this)}return createClass(e,[{key:"connect",value:function(){var e=this;return new Promise(function(t,r){e.timeout=setTimeout(function(){r(new Error("membership subscription timed out"))},e.connectionTimeout),e.onSubscriptionEstablished=function(r){clearTimeout(e.timeout),t(r)},e.sub=e.instance.subscribeNonResuming({path:"/rooms/"+encodeURIComponent(e.roomId)+"/memberships",listeners:{onError:function(t){clearTimeout(e.timeout),r(t)},onEvent:e.onEvent}})})}},{key:"cancel",value:function(){clearTimeout(this.timeout);try{this.sub&&this.sub.unsubscribe()}catch(e){this.logger.debug("error when cancelling membership subscription",e)}}},{key:"onEvent",value:function(e){var t=e.body;switch(t.event_name){case"initial_state":this.onInitialState(t.data);break;case"user_joined":this.onUserJoined(t.data);break;case"user_left":this.onUserLeft(t.data)}}},{key:"onInitialState",value:function(e){var t=this,r=e.user_ids;this.established?handleMembershipSubReconnection({userIds:r,roomId:this.roomId,roomStore:this.roomStore,userStore:this.userStore,onUserJoinedRoomHook:this.onUserJoinedRoomHook,onUserLeftRoomHook:this.onUserLeftRoomHook}):(this.established=!0,this.roomStore.update(this.roomId,{userIds:r}).then(function(){t.onSubscriptionEstablished()}))}},{key:"onUserJoined",value:function(e){var t=this,r=e.user_id;this.roomStore.addUserToRoom(this.roomId,r).then(function(e){return t.userStore.get(r).then(function(r){return t.onUserJoinedRoomHook(e,r)})})}},{key:"onUserLeft",value:function(e){var t=this,r=e.user_id;this.roomStore.removeUserFromRoom(this.roomId,r).then(function(e){return t.userStore.get(r).then(function(r){return t.onUserLeftRoomHook(e,r)})})}}]),e}(),RoomSubscription=function(){function e(t){classCallCheck(this,e),this.buffer=[],this.messageSub=new MessageSubscription({roomId:t.roomId,messageLimit:t.messageLimit,userId:t.userId,instance:t.serverInstance,userStore:t.userStore,roomStore:t.roomStore,typingIndicators:t.typingIndicators,logger:t.logger,connectionTimeout:t.connectionTimeout,onMessageHook:this.bufferWhileConnecting(function(e){t.hooks.rooms[t.roomId]&&t.hooks.rooms[t.roomId].onMessage&&t.hooks.rooms[t.roomId].onMessage(e)})}),this.cursorSub=new CursorSubscription({roomId:t.roomId,cursorStore:t.cursorStore,instance:t.cursorsInstance,logger:t.logger,connectionTimeout:t.connectionTimeout,onNewCursorHook:this.bufferWhileConnecting(function(e){t.hooks.rooms[t.roomId]&&t.hooks.rooms[t.roomId].onNewReadCursor&&0===e.type&&e.userId!==t.userId&&t.hooks.rooms[t.roomId].onNewReadCursor(e)})}),this.membershipSub=new MembershipSubscription({roomId:t.roomId,instance:t.serverInstance,userStore:t.userStore,roomStore:t.roomStore,logger:t.logger,connectionTimeout:t.connectionTimeout,onUserJoinedRoomHook:this.bufferWhileConnecting(function(e,r){t.hooks.global.onUserJoinedRoom&&t.hooks.global.onUserJoinedRoom(e,r),t.hooks.rooms[e.id]&&t.hooks.rooms[e.id].onUserJoined&&t.hooks.rooms[e.id].onUserJoined(r)}),onUserLeftRoomHook:this.bufferWhileConnecting(function(e,r){t.hooks.global.onUserLeftRoom&&t.hooks.global.onUserLeftRoom(e,r),t.hooks.rooms[e.id]&&t.hooks.rooms[e.id].onUserLeft&&t.hooks.rooms[e.id].onUserLeft(r)})})}return createClass(e,[{key:"connect",value:function(){var e=this;return this.cancelled?Promise.reject(new Error("attempt to connect a cancelled room subscription")):Promise.all([this.messageSub.connect(),this.cursorSub.connect(),this.membershipSub.connect()]).then(function(){return e.flushBuffer()})}},{key:"cancel",value:function(){this.cancelled=!0,this.messageSub.cancel(),this.cursorSub.cancel(),this.membershipSub.cancel()}},{key:"bufferWhileConnecting",value:function(e){var t=this;return function(){for(var r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];t.connected?e.apply(void 0,n):t.buffer.push(e.bind.apply(e,[t].concat(n)))}}},{key:"flushBuffer",value:function(){this.connected=!0,this.buffer.forEach(function(e){return e()}),delete this.buffer}}]),e}(),CurrentUser=function(){function e(t){var r=this,n=t.serverInstanceV2,o=t.serverInstanceV4,s=t.connectionTimeout,i=t.cursorsInstance,a=t.filesInstance,u=t.hooks,c=t.id,h=t.presenceInstance;classCallCheck(this,e),this.hooks={global:u,rooms:{}},this.id=c,this.encodedId=encodeURIComponent(this.id),this.serverInstanceV2=n,this.serverInstanceV4=o,this.filesInstance=a,this.cursorsInstance=i,this.connectionTimeout=s,this.presenceInstance=h,this.logger=o.logger,this.presenceStore={},this.userStore=new UserStore({instance:this.serverInstanceV4,presenceStore:this.presenceStore,logger:this.logger}),this.roomStore=new RoomStore({instance:this.serverInstanceV4,userStore:this.userStore,isSubscribedTo:function(e){return r.isSubscribedTo(e)},logger:this.logger}),this.cursorStore=new CursorStore({instance:this.cursorsInstance,userStore:this.userStore,roomStore:this.roomStore,logger:this.logger}),this.typingIndicators=new TypingIndicators({hooks:this.hooks,instance:this.serverInstanceV4,logger:this.logger}),this.userStore.onSetHooks.push(function(e){return r.subscribeToUserPresence(e)}),this.roomSubscriptions={},this.readCursorBuffer={},this.userPresenceSubscriptions={},this.setReadCursor=this.setReadCursor.bind(this),this.readCursor=this.readCursor.bind(this),this.isTypingIn=this.isTypingIn.bind(this),this.createRoom=this.createRoom.bind(this),this.getJoinableRooms=this.getJoinableRooms.bind(this),this.joinRoom=this.joinRoom.bind(this),this.leaveRoom=this.leaveRoom.bind(this),this.addUserToRoom=this.addUserToRoom.bind(this),this.removeUserFromRoom=this.removeUserFromRoom.bind(this),this.sendMessage=this.sendMessage.bind(this),this.sendSimpleMessage=this.sendSimpleMessage.bind(this),this.sendMultipartMessage=this.sendMultipartMessage.bind(this),this.fetchMessages=this.fetchMessages.bind(this),this.fetchMultipartMessages=this.fetchMultipartMessages.bind(this),this.subscribeToRoom=this.subscribeToRoom.bind(this),this.subscribeToRoomMultipart=this.subscribeToRoomMultipart.bind(this),this.updateRoom=this.updateRoom.bind(this),this.deleteRoom=this.deleteRoom.bind(this),this.setReadCursorRequest=this.setReadCursorRequest.bind(this),this.uploadDataAttachment=this.uploadDataAttachment.bind(this),this.isMemberOf=this.isMemberOf.bind(this),this.isSubscribedTo=this.isSubscribedTo.bind(this),this.decorateMessage=this.decorateMessage.bind(this),this.setPropertiesFromBasicUser=this.setPropertiesFromBasicUser.bind(this),this.establishUserSubscription=this.establishUserSubscription.bind(this),this.establishPresenceSubscription=this.establishPresenceSubscription.bind(this),this.subscribeToUserPresence=this.subscribeToUserPresence.bind(this),this.disconnect=this.disconnect.bind(this),this._uploadAttachment=this._uploadAttachment.bind(this)}return createClass(e,[{key:"setReadCursor",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.roomId,n=t.position;return typeCheck("roomId","string",r),typeCheck("position","number",n),new Promise(function(t,o){void 0!==e.readCursorBuffer[r]?(e.readCursorBuffer[r].position=max(e.readCursorBuffer[r].position,n),e.readCursorBuffer[r].callbacks.push({resolve:t,reject:o})):(e.readCursorBuffer[r]={position:n,callbacks:[{resolve:t,reject:o}]},setTimeout(function(){e.setReadCursorRequest(_extends({roomId:r},e.readCursorBuffer[r])),delete e.readCursorBuffer[r]},SET_CURSOR_WAIT))})}},{key:"readCursor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.roomId,r=e.userId,n=void 0===r?this.id:r;if(typeCheck("roomId","string",t),typeCheck("userId","string",n),n!==this.id&&!this.isSubscribedTo(t)){var o=new Error("Must be subscribed to room "+t+" to access member's read cursors");throw this.logger.error(o),o}return this.cursorStore.getSync(n,t)}},{key:"isTypingIn",value:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).roomId;return typeCheck("roomId","string",e),this.typingIndicators.sendThrottledRequest(e)}},{key:"createRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.name,n=t.addUserIds,o=t.customData,s=objectWithoutProperties(t,["name","addUserIds","customData"]);return r&&typeCheck("name","string",r),n&&typeCheckArr("addUserIds","string",n),o&&typeCheck("customData","object",o),this.serverInstanceV4.request({method:"POST",path:"/rooms",json:{created_by_id:this.id,name:r,private:!!s.private,user_ids:n,custom_data:o}}).then(function(t){return e.roomStore.set(parseBasicRoom(JSON.parse(t)))}).catch(function(t){throw e.logger.warn("error creating room:",t),t})}},{key:"getJoinableRooms",value:function(){var e=this;return this.serverInstanceV4.request({method:"GET",path:"/users/"+this.encodedId+"/rooms?joinable=true"}).then(pipe(JSON.parse,map(parseBasicRoom))).catch(function(t){throw e.logger.warn("error getting joinable rooms:",t),t})}},{key:"joinRoom",value:function(){var e=this,t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).roomId;return typeCheck("roomId","string",t),this.isMemberOf(t)?this.roomStore.get(t):this.serverInstanceV4.request({method:"POST",path:"/users/"+this.encodedId+"/rooms/"+encodeURIComponent(t)+"/join"}).then(function(t){return e.roomStore.set(parseBasicRoom(JSON.parse(t)))}).catch(function(r){throw e.logger.warn("error joining room "+t+":",r),r})}},{key:"leaveRoom",value:function(){var e=this,t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).roomId;return typeCheck("roomId","string",t),this.roomStore.get(t).then(function(r){return e.serverInstanceV4.request({method:"POST",path:"/users/"+e.encodedId+"/rooms/"+encodeURIComponent(t)+"/leave"}).then(function(){return r})}).catch(function(r){throw e.logger.warn("error leaving room "+t+":",r),r})}},{key:"addUserToRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.userId,n=t.roomId;return typeCheck("userId","string",r),typeCheck("roomId","string",n),this.serverInstanceV4.request({method:"PUT",path:"/rooms/"+encodeURIComponent(n)+"/users/add",json:{user_ids:[r]}}).then(function(){return e.roomStore.addUserToRoom(n,r)}).catch(function(t){throw e.logger.warn("error adding user "+r+" to room "+n+":",t),t})}},{key:"removeUserFromRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.userId,n=t.roomId;return typeCheck("userId","string",r),typeCheck("roomId","string",n),this.serverInstanceV4.request({method:"PUT",path:"/rooms/"+encodeURIComponent(n)+"/users/remove",json:{user_ids:[r]}}).then(function(){return e.roomStore.removeUserFromRoom(n,r)}).catch(function(t){throw e.logger.warn("error removing user "+r+" from room "+n+":",t),t})}},{key:"sendMessage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.text,n=t.roomId,o=t.attachment;return typeCheck("text","string",r),typeCheck("roomId","string",n),new Promise(function(t,r){void 0!==o&&isDataAttachment(o)?t(e.uploadDataAttachment(n,o)):void 0!==o&&isLinkAttachment(o)?t({resource_link:o.link,type:o.type}):void 0!==o?r(new TypeError("attachment was malformed")):t()}).then(function(t){return e.serverInstanceV2.request({method:"POST",path:"/rooms/"+encodeURIComponent(n)+"/messages",json:{text:r,attachment:t}})}).then(pipe(JSON.parse,prop("message_id"))).catch(function(t){throw e.logger.warn("error sending message to room "+n+":",t),t})}},{key:"sendSimpleMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.roomId,r=e.text;return this.sendMultipartMessage({roomId:t,parts:[{type:"text/plain",content:r}]})}},{key:"sendMultipartMessage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.roomId,n=t.parts;return typeCheck("roomId","string",r),typeCheckArr("parts","object",n),0===n.length?Promise.reject(new TypeError("message must contain at least one part")):Promise.all(n.map(function(t){return t.type=t.type||t.file&&t.file.type,typeCheck("part.type","string",t.type),t.content&&typeCheck("part.content","string",t.content),t.url&&typeCheck("part.url","string",t.url),t.name&&typeCheck("part.name","string",t.name),t.file&&typeCheck("part.file.size","number",t.file.size),t.file?e._uploadAttachment({roomId:r,part:t}):t})).then(function(t){return e.serverInstanceV4.request({method:"POST",path:"/rooms/"+encodeURIComponent(r)+"/messages",json:{parts:t.map(function(e){return{type:e.type,content:e.content,url:e.url,attachment:e.attachment}})}})}).then(function(e){return JSON.parse(e).message_id}).catch(function(t){throw e.logger.warn("error sending message to room "+r+":",t),t})}},{key:"fetchMessages",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.roomId,n=t.initialId,o=t.limit,s=t.direction,i=t.serverInstance;return typeCheck("roomId","string",r),n&&typeCheck("initialId","number",n),o&&typeCheck("limit","number",o),s&&checkOneOf("direction",["older","newer"],s),(i||this.serverInstanceV2).request({method:"GET",path:"/rooms/"+encodeURIComponent(r)+"/messages?"+urlEncode({initial_id:n,limit:o,direction:s})}).then(function(t){var r=JSON.parse(t).map(function(t){return e.decorateMessage(parseBasicMessage(t))});return e.userStore.fetchMissingUsers(uniq(map(prop("senderId"),r))).then(function(){return sort(function(e,t){return e.id-t.id},r)})}).catch(function(t){throw e.logger.warn("error fetching messages from room "+r+":",t),t})}},{key:"fetchMultipartMessages",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.fetchMessages(_extends({},e,{serverInstance:this.serverInstanceV4}))}},{key:"subscribeToRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.roomId,n=t.hooks,o=void 0===n?{}:n,s=t.messageLimit,i=t.serverInstance;typeCheck("roomId","string",r),typeCheckObj("hooks","function",o),s&&typeCheck("messageLimit","number",s),this.roomSubscriptions[r]&&this.roomSubscriptions[r].cancel(),this.hooks.rooms[r]=o;var a=new RoomSubscription({serverInstance:i||this.serverInstanceV2,connectionTimeout:this.connectionTimeout,cursorStore:this.cursorStore,cursorsInstance:this.cursorsInstance,hooks:this.hooks,logger:this.logger,messageLimit:s,roomId:r,roomStore:this.roomStore,typingIndicators:this.typingIndicators,userId:this.id,userStore:this.userStore});return this.roomSubscriptions[r]=a,this.joinRoom({roomId:r}).then(function(e){return a.connect().then(function(){return e})}).catch(function(t){throw e.logger.warn("error subscribing to room "+r+":",t),t})}},{key:"subscribeToRoomMultipart",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.subscribeToRoom(_extends({},e,{serverInstance:this.serverInstanceV4}))}},{key:"updateRoom",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.roomId,n=t.name,o=t.customData,s=objectWithoutProperties(t,["roomId","name","customData"]);return typeCheck("roomId","string",r),n&&typeCheck("name","string",n),s.private&&typeCheck("private","boolean",s.private),o&&typeCheck("customData","object",o),this.serverInstanceV4.request({method:"PUT",path:"/rooms/"+encodeURIComponent(r),json:{name:n,private:s.private,custom_data:o}}).then(function(){}).catch(function(t){throw e.logger.warn("error updating room:",t),t})}},{key:"deleteRoom",value:function(){var e=this,t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).roomId;return typeCheck("roomId","string",t),this.serverInstanceV4.request({method:"DELETE",path:"/rooms/"+encodeURIComponent(t)}).then(function(){}).catch(function(t){throw e.logger.warn("error deleting room:",t),t})}},{key:"setReadCursorRequest",value:function(e){var t=this,r=e.roomId,n=e.position,o=e.callbacks;return this.cursorsInstance.request({method:"PUT",path:"/cursors/0/rooms/"+encodeURIComponent(r)+"/users/"+this.encodedId,json:{position:n}}).then(function(){return map(function(e){return e.resolve()},o)}).catch(function(e){t.logger.warn("error setting cursor:",e),map(function(t){return t.reject(e)},o)})}},{key:"uploadDataAttachment",value:function(e,t){var r=t.file,n=t.name,o=new FormData;return o.append("file",r,n),this.filesInstance.request({method:"POST",path:"/rooms/"+encodeURIComponent(e)+"/users/"+this.encodedId+"/files/"+encodeURIComponent(n),body:o}).then(JSON.parse)}},{key:"_uploadAttachment",value:function(e){var t=e.roomId,r=e.part,n=r.type,o=r.name,s=r.customData,i=r.file;return this.serverInstanceV4.request({method:"POST",path:"/rooms/"+encodeURIComponent(t)+"/attachments",json:{content_type:n,content_length:i.size,origin:window&&window.location&&window.location.origin,name:o||i.name,custom_data:s}}).then(function(e){var t=JSON.parse(e),r=t.attachment_id,o=t.upload_url;return reactNative_4({method:"PUT",url:o,body:i,headers:{"content-type":n}}).then(function(){return{type:n,attachment:{id:r}}})})}},{key:"isMemberOf",value:function(e){return contains$1(e,map(prop("id"),this.rooms))}},{key:"isSubscribedTo",value:function(e){return has(e,this.roomSubscriptions)}},{key:"decorateMessage",value:function(e){return new Message(e,this.userStore,this.roomStore,this.serverInstanceV4)}},{key:"setPropertiesFromBasicUser",value:function(e){this.avatarURL=e.avatarURL,this.createdAt=e.createdAt,this.customData=e.customData,this.name=e.name,this.updatedAt=e.updatedAt}},{key:"establishUserSubscription",value:function(){var e=this;return this.userSubscription=new UserSubscription({hooks:this.hooks,userId:this.id,instance:this.serverInstanceV4,roomStore:this.roomStore,cursorStore:this.cursorStore,typingIndicators:this.typingIndicators,logger:this.logger,connectionTimeout:this.connectionTimeout,currentUser:this}),this.userSubscription.connect().then(function(t){var r=t.basicUser,n=t.basicRooms,o=t.basicCursors;return e.setPropertiesFromBasicUser(r),Promise.all([].concat(toConsumableArray(n.map(function(t){return e.roomStore.set(t)})),toConsumableArray(o.map(function(t){return e.cursorStore.set(t)}))))}).catch(function(t){throw e.logger.error("error establishing user subscription:",t),t})}},{key:"establishPresenceSubscription",value:function(){var e=this;return this.presenceSubscription=new PresenceSubscription({userId:this.id,instance:this.presenceInstance,logger:this.logger,connectionTimeout:this.connectionTimeout}),Promise.all([this.userStore.fetchBasicUsers([this.id]),this.subscribeToUserPresence(this.id),this.presenceSubscription.connect().catch(function(t){throw e.logger.warn("error establishing presence subscription:",t),t})])}},{key:"subscribeToUserPresence",value:function(e){if(this.userPresenceSubscriptions[e])return Promise.resolve();var t=new UserPresenceSubscription({hooks:this.hooks,userId:e,instance:this.presenceInstance,userStore:this.userStore,roomStore:this.roomStore,presenceStore:this.presenceStore,logger:this.logger,connectionTimeout:this.connectionTimeout});return this.userPresenceSubscriptions[e]=t,t.connect()}},{key:"disconnect",value:function(){this.userSubscription.cancel(),this.presenceSubscription.cancel(),forEachObjIndexed(function(e){return e.cancel()},this.roomSubscriptions),forEachObjIndexed(function(e){return e.cancel()},this.userPresenceSubscriptions)}},{key:"rooms",get:function(){return values(this.roomStore.snapshot())}},{key:"users",get:function(){return values(this.userStore.snapshot())}}]),e}(),isDataAttachment=function(e){var t=e.file,r=e.name;return void 0!==t&&void 0!==r&&(typeCheck("attachment.file","object",t),typeCheck("attachment.name","string",r),!0)},isLinkAttachment=function(e){var t=e.link,r=e.type;return void 0!==t&&void 0!==r&&(typeCheck("attachment.link","string",t),typeCheck("attachment.type","string",r),!0)},version="1.5.0",ChatManager=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.instanceLocator,n=t.tokenProvider,o=t.userId,s=objectWithoutProperties(t,["instanceLocator","tokenProvider","userId"]);classCallCheck(this,e),typeCheck("instanceLocator","string",r),typeCheck("tokenProvider","object",n),typeCheck("tokenProvider.fetchToken","function",n.fetchToken),typeCheck("userId","string",o);var i=split(":",r)[1];if(void 0===i)throw new TypeError("expected instanceLocator to be of the format x:y:z, but was "+r);var a=s.baseClient||new reactNative_1({host:i+"."+reactNative_2,logger:s.logger,sdkProduct:"chatkit",sdkVersion:version});"function"==typeof n.setUserId&&n.setUserId(o);var u={client:a,locator:r,logger:s.logger,tokenProvider:n};this.serverInstanceV2=new reactNative_3(_extends({serviceName:"chatkit",serviceVersion:"v2"},u)),this.serverInstanceV4=new reactNative_3(_extends({serviceName:"chatkit",serviceVersion:"v4"},u)),this.filesInstance=new reactNative_3(_extends({serviceName:"chatkit_files",serviceVersion:"v1"},u)),this.cursorsInstance=new reactNative_3(_extends({serviceName:"chatkit_cursors",serviceVersion:"v2"},u)),this.presenceInstance=new reactNative_3(_extends({serviceName:"chatkit_presence",serviceVersion:"v2"},u)),this.userId=o,this.connectionTimeout=s.connectionTimeout||DEFAULT_CONNECTION_TIMEOUT,this.connect=this.connect.bind(this),this.disconnect=this.disconnect.bind(this)}return createClass(e,[{key:"connect",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};typeCheckObj("hooks","function",t);var r=new CurrentUser({hooks:t,id:this.userId,serverInstanceV2:this.serverInstanceV2,serverInstanceV4:this.serverInstanceV4,filesInstance:this.filesInstance,cursorsInstance:this.cursorsInstance,presenceInstance:this.presenceInstance,connectionTimeout:this.connectionTimeout});return Promise.all([r.establishUserSubscription(),r.establishPresenceSubscription()]).then(function(){return e.currentUser=r,r})}},{key:"disconnect",value:function(){this.currentUser&&this.currentUser.disconnect()}}]),e}(),main$1={TokenProvider:TokenProvider,ChatManager:ChatManager};module.exports=main$1;
